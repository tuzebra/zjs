zjs.require("ui.popup",function(){zjs.enablehook(!0);zjs.extendCore({moduleZmvcOpengraphOption:{opengraphurl:"",id:0,type:"",customid:"",time:!1,likes:0,comments:0,labellike:"Th\u00edch",labelliked:"\u0110\u00e3 th\u00edch",labellikecounthtml:"<span>${count}</span>",likesiframe:!0,labelcommentcounthtml:"<span>${count}</span>",hidecommentpanel:!1,hidecommentpanelwhennocomment:!0,customclass:""}});var n=function(){var c=!1;try{top.document.body.offsetTop=top.document.body.offsetTop,c=!0}catch(m){}return c},
p=function(c,m){var h=zjs(c),a=h.getData("zmodulezmvcopengraphlikebuttonoption");if(!a){var a=zjs.clone(zjs.moduleZmvcOpengraphOption),k;k=n()?top.zjs("script[name=opengraph]").getAttr("href",""):window.zjs("script[name=opengraph]").getAttr("href","");""!=k&&(a.opengraphurl=k);k=h.getAttr("data-option","");zjs.isString(k)&&""!=k.trim()&&(a=zjs.extend(a,k.jsonDecode()));h.removeAttr("data-option");"undefined"!=typeof m&&(a=zjs.extend(a,m));h.setData("zmodulezmvcopengraphlikebuttonoption",a);var e=
h.find(".likebutton"),g=h.find(".likecount"),l=h.find(".commentbutton"),f=h.find(".commentcount"),d=h.find(".commentpanel");0>=e.count()&&0>=g.count()&&0>=l.count()&&0>=f.count()&&0>=d.count()||(d.addClass("zmvc-commentpanel"),zjs.ajax({url:a.opengraphurl+"/liked",method:"get",type:"json",cache:!1,data:{id:a.id,type:a.type,customid:a.customid,customclass:a.customclass},onComplete:function(c){if("undefined"!=typeof c.success&&c.success){a=zjs.extend(a,c.opengraph);0<e.count()&&(e.addClass("zmvc-likebtn"),
e.setData("zmodulezmvcopengraphlikebuttonliked",c.liked?!0:!1),e.find(".label").html(e.data("zmodulezmvcopengraphlikebuttonliked")?a.labelliked:a.labellike),e.addClass(e.data("zmodulezmvcopengraphlikebuttonliked")?"zmvc-likebtn-liked":"zmvc-likebtn-like"),e.removeClass("zmvcoguninithide"),e.click(function(b){b.preventDefault();b=n()?top.zjs("#popupzmvcopengraphlogin"):zjs("#popupzmvcopengraphlogin");0<b.count()?(b.popupShow(),b.find("input[type=text]:first-child").focus()):(a.likes+=e.data("zmodulezmvcopengraphlikebuttonliked")?
-1:1,zjs.ajax({url:a.opengraphurl+"/"+(e.data("zmodulezmvcopengraphlikebuttonliked")?"unlike":"like"),method:"post",data:{id:a.id}}),e.setData("zmodulezmvcopengraphlikebuttonliked",!e.data("zmodulezmvcopengraphlikebuttonliked")),e.find(".label").html(e.data("zmodulezmvcopengraphlikebuttonliked")?a.labelliked:a.labellike),e.removeClass("zmvc-likebtn-liked zmvc-likebtn-like").addClass(e.data("zmodulezmvcopengraphlikebuttonliked")?"zmvc-likebtn-liked":"zmvc-likebtn-like"),0<g.count()&&(0==a.likes?g.hide():
g.show(),g.find(".int").html(a.likes)))}));0>=g.count()&&0<e.count()&&(c=a.labellikecounthtml.replace("${count}",'<span class="int"></span>'),g=zjs(c).insertAfter(e));0<g.count()&&(g.removeClass("zmvcoguninithide").addClass("zmvc-likecount"),0==a.likes&&g.hide(),g.find(".int").html(a.likes),g.click(function(b){b.preventDefault();a.likesiframe&&zjs("<div></div>").appendTo(n()?top.document.body:document.body).addClass("zmvc-likecount-popup").makePopup({autoshow:!0,closethenremove:!0,clickout:!0,center:!0}).find(".zui-popup-wrapper").append('<iframe src="'+
a.opengraphurl+"/likesiframe/"+a.id+'"></iframe>')}));0<l.count()&&(l.addClass("zmvc-commentbtn"),l.removeClass("zmvcoguninithide"),l.click(function(a){a.stop();a=n()?top.zjs("#popupzmvcopengraphlogin"):zjs("#popupzmvcopengraphlogin");0<a.count()?(a.popupShow(),a.find("input[type=text]:first-child").focus()):0<d.count()&&d.removeClass("zmvcoguninithide").find("textarea").trigger("click").focus()}));0>=f.count()&&0<l.count()&&(c=a.labelcommentcounthtml.replace("${count}",'<span class="int"></span>'),
f=zjs(c).insertAfter(l));0<f.count()&&(f.removeClass("zmvcoguninithide").addClass("zmvc-commentcount"),0==a.comments?f.hide():f.find(".int").html(a.comments));0<d.count()&&zjs.ajax({url:a.opengraphurl+"/comments",method:"get",type:"json",cache:!1,data:{id:a.id,html:2,customclass:a.customclass},onComplete:function(b){"undefined"!=typeof b.success&&b.success&&(d.html(b.html),a.hidecommentpanel||a.hidecommentpanelwhennocomment&&0>=b.comments.total||d.removeClass("zmvcoguninithide"),a.comments=b.comments.total,
0==a.comments&&f.hide(),f.find(".int").html(a.comments),d.find(".comment-composer-attach-wrapper .btnchoiceimage").on("ui.button.file.upload.complete",function(a,b){a.data.response.success&&a.data.response.files.each(function(a){d.find(".comment-composer-text-wrapper .comment-attach-image-wrapper").remove();d.find(".comment-composer-text-wrapper").append('<div class="comment-attach-image-wrapper" data-id="'+a.id+'"><img src="'+a.url+'" /><a class="remove zhovercardcenter" title="Xo\u00e1 \u1ea3nh n\u00e0y" data-option="timeBeforeShow:0,timeBeforeHide:0,horizontal:\'center\',vertical:\'top\',autoFixPosition:false,hideWhenHoverCard:true">\u00d7</a></div>')})}),
d.find(".comment-composer-text-wrapper").on("click",".comment-attach-image-wrapper .remove",function(a){a.preventDefault();this.parent().remove()}),b=d.find("textarea"),0<b.count()&&(b.addClass("zmvc-commenttextarea"),b.click(function(a){a&&a.stop&&a.stop();d.find(".comment-composer-text-border").addClass("focus")}),b.on("keypress",function(b){if(this.hasClass("posting"))b.preventDefault(),b.stop();else if(13==b.keyCode()&&!b.shiftKey()&&(b.preventDefault(),b.stop(),b=this.getValue("").trim(),""!=
b)){var c=0;d.find(".comment-composer-text-wrapper .comment-attach-image-wrapper").each(function(a){c=zjs(a).getAttr("data-id",0).toInt()});d.find(".comment-composer-text-border").addClass("posting");var e=this;zjs.ajax({url:a.opengraphurl+"/comment",method:"post",type:"json",cache:!1,data:{id:a.id,content:b,imageid:c,customclass:a.customclass},onComplete:function(b){d.find(".comment-composer-text-border").removeClass("posting");"undefined"!=typeof b.success&&b.success&&(e.setValue(""),d.find(".comment-composer-text-wrapper .comment-attach-image-wrapper").remove(),
d.find(".comment-rows").append(b.html),a.comments++,0==a.comments?f.hide():f.show().find(".int").html(a.comments),h.trigger("zmvc.opengraph.newcomment"))}})}})))}});if(0<d.count())d.on("click",".comment-loadmore-wrapper",function(b){b.preventDefault();if(!this.hasClass("loading")){var c=this.addClass("loading");b=c.getAttr("data-nextstart");var e=c.getAttr("data-nextlimit");zjs.ajax({url:a.opengraphurl+"/comments",method:"get",type:"json",cache:!1,data:{id:a.id,start:b,limit:e,html:1,customclass:a.customclass},
onComplete:function(a){if("undefined"!=typeof a.success&&a.success){c.removeClass("loading");zjs.foreach(a.comments.rows,function(a){d.find(".comment-rows").prepend(a.html)});if(0>=a.comments.nextstart)return c.remove();c.setAttr("data-nextstart",a.comments.nextstart).setAttr("data-nextlimit",a.comments.nextlimit).find(".count").html(a.comments.nextlimit)}}})}});0<d.count()&&(d.on("click",".comment-remove[data-id]",function(b){b.preventDefault();b=this.getAttr("data-id");var c=d.find(".comment-row[data-id="+
b+"]");zjs.ajax({url:a.opengraphurl+"/removeComment",method:"post",data:{commentid:b,trash:1}});c.addClass("removed");a.comments--;0==a.comments?f.hide():f.show().find(".int").html(a.comments)}),d.on("click",".comment-remove-undo[data-id]",function(b){b.preventDefault();b=this.getAttr("data-id");var c=d.find(".comment-row[data-id="+b+"]");zjs.ajax({url:a.opengraphurl+"/removeComment",method:"post",data:{commentid:b,trash:0}});c.removeClass("removed");a.comments++;f.show().find(".int").html(a.comments)}))}}}))}};
zjs.extendMethod({makeOgFeedback:function(c){return this.each(function(m){p(m,c)})}});zjs.hook({after_setInnerHTML:function(c){zjs(c).find(".zmvcogfeedback").makeOgFeedback()},after_insertDOM:function(c){zjs(c).hasClass("zmvcogfeedback")&&zjs(c).makeOgFeedback();zjs(c).find(".zmvcogfeedback").makeOgFeedback()}});zjs.onready(function(){zjs(".zmvcogfeedback").makeOgFeedback();zjs(document).click(function(){zjs(".comment-composer-text-border").removeClass("focus")})});"required"in zjs&&zjs.required("zmvc.opengraph");
zjs.require("textarea.autoheight, ui.button.file")});
