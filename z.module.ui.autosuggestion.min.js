zjs.require("dictionary, scrollbar",function(){zjs.extendCore({moduleUiAutosuggestionOption:{minlength:1,minheight:18,customcss:!0,labelPlaceholder:!1,focusshowsuggestion:!1,autofocus:!1,panelmaxheight:200,multiline:!0,multichoice:!1,mentionmode:!1,usedproperty:"text",searchproperty:"text",searchMatchStartWith:!1,usedpropertytext:!1,limit:0,noneValue:"",source:[],sourceUrl:"",initSourceUrl:"",sourceDataStructure:"",cacheResponse:!0,itemtemplate:'<div class="item">${text}</div>',itemLinkFormat:"",
itemhighlightclass:"highlight",defaultPanelHeight:0,selectLikeInput:!1}});var P="oninput"in document.createElement("input"),O=function(d,g){var b=zjs(d),a=b.getData("zjsmoduleautosuggestionoption"),E=!1;if(a)b.setData("zjsmoduleautosuggestionoption",zjs.extend(a,g)),E=!0;else{var G=!0,B=!1;a=zjs.clone(zjs.moduleUiAutosuggestionOption);var w=b.getAttr("data-option","");zjs.isString(w)&&""!=w.trim()&&(a=zjs.extend(a,w.jsonDecode()));b.removeAttr("data-option");a.sourceUrl||(w=b.getAttr("data-autocomplete-path",
""),""!==w&&(a.sourceUrl=w));zjs.hook({after_setAttr:function(c,f,e){c===d&&"data-autocomplete-path"===f&&(c=b.getAttr("data-autocomplete-path",""),""==c?G=!1:(G=!0,a.sourceUrl=c,t.setDataSourceUrl(a.sourceUrl)))}});"undefined"!=typeof g&&(a=zjs.extend(a,g));var H=b.getValue(""),q=!1;if(zjs.isString(a.source)||b.is("select"))q=zjs.isString(a.source)?zjs(a.source):b,0<q.count()?(B=b.is("select"),a.multichoice=!1,a.usedproperty="id.text",a.source={},q.find("option").eachElement(function(c,f){var e=
zjs(c).getValue(),d=zjs(c).getInnerText();e!==a.noneValue&&(a.source[e]=d,0===f&&e!=a.noneValue&&b.setValue(e),c.selected&&e!=a.noneValue&&(H=d,B?q.setValue(e):b.setValue(d)))}),q.hide(),B?a.selectLikeInput&&q.addClass("select-like-input"):q.removeAttr("required").removeClass("required")):q=!1;B&&!a.selectLikeInput&&(a.focusshowsuggestion=!0);w=a.searchproperty;"id.text"==a.usedproperty&&(a.searchproperty="text",a.usedproperty="id",w="id.text");a.mentionmode&&(a.multichoice=!1);a.multichoice&&(a.multiline=
!1);a.limit=parseInt(a.limit);isNaN(a.limit)&&(a.limit=0);a.defaultPanelHeight=parseInt(a.defaultPanelHeight);isNaN(a.defaultPanelHeight)&&(a.defaultPanelHeight=0);a.selectLikeInput=!!a.selectLikeInput;b.setData("zjsmoduleautosuggestionoption",a);var h=zjs('<div class="zui-autosuggestion-wrap"><div class="zui-autosuggestion-inputwrap"><div class="zui-autosuggestion-placeholder"></div><input class="zui-autosuggestion-input" autocomplete="off" /><textarea class="zui-autosuggestion-input" autocomplete="off"></textarea><div class="zui-autosuggestion-input-test-wrap"><div class="zui-autosuggestion-input-test"></div></div><div class="zui-estimate-height-wrap"><div class="zui-autosuggestion-input zui-estimate-height"></div></div></div><div class="zui-autosuggestion-panel-wrap zui-panel-hide"><div class="zui-autosuggestion-panel-scroll"><div class="zui-autosuggestion-panel-content"></div></div></div></div>');
a.multiline?h.find("input.zui-autosuggestion-input").remove():h.find("textarea.zui-autosuggestion-input").remove();b.setData("zmoduleautosuggestionwrapel",h);h.insertAfter(b);var u=h.find(".zui-autosuggestion-inputwrap"),m=h.find(".zui-autosuggestion-placeholder"),e=h.find("input.zui-autosuggestion-input,textarea.zui-autosuggestion-input"),n=h.find(".zui-autosuggestion-panel-wrap"),I=h.find(".zui-autosuggestion-panel-scroll"),v=h.find(".zui-autosuggestion-panel-content"),J=!1;e.setAttr("autocomplete",
Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10));b.setData("zmoduleautosuggestionwrapinputel",u);b.setData("zjsmoduleautosuggestionnewinput",e.item(0,!0));a.multiline?(J=h.find(".zui-estimate-height"),h.addClass("multiline")):h.find(".zui-estimate-height-wrap").remove();if(!a.customcss){var C=b.width(),Q=b.height();b.getStyle("margin-left",!0);b.getStyle("margin-right",!0);b.getStyle("margin-top",!0);b.getStyle("margin-bottom",!0);var O=b.getStyle("padding-left",!0),Z=b.getStyle("padding-right",
!0),aa=b.getStyle("padding-top",!0),ba=b.getStyle("padding-bottom",!0),ca=b.getStyle("border-left-width",!0),da=b.getStyle("border-right-width",!0),ea=b.getStyle("border-top-width",!0),fa=b.getStyle("border-bottom",!0),ha=b.getStyle("font");"content-box"==b.getStyle("box-sizing")&&(C-=O+Z+ca+da,Q-=aa+ba+ea+fa);u.copyStyleFrom(b);u.setStyle({position:"relative",cursor:"text",width:C,height:Q,"-webkit-text-fill-color":"initial"});e.setStyle({top:m.top(),font:ha,width:C})}var K=!1;a.multichoice?(h.addClass("zui-autosuggestion-multi-wrap"),
K=h.find(".zui-autosuggestion-input-test").setStyle({margin:e.getStyle("margin"),padding:e.getStyle("padding"),font:e.getStyle("font"),border:e.getStyle("border")})):h.find(".zui-autosuggestion-input-test-wrap").remove();n.height(a.panelmaxheight);I.makeScrollbar({bounce:!1,usecss:!1,usekey:!1,customCssClass:"zui-autosuggestion-panel",autoUseDefaultWithMobile:!0});n.addClass("zui-panel-hide");var R=function(c){c=Math.min(c,a.panelmaxheight);n.height(c);I.scrollHeight(c).scrollToTop()},S="",x=function(){return b.getAttr("data-placeholder",
b.getAttr("placeholder",""))},p=0,F=0,k="",r="",z=0,T="";C=x();a.labelPlaceholder&&""!==C&&(zjs("<span>").addClass("placeholder").html(C).insertAfter(u),u.addClass("label-placeholder"));l(m,x());b.hide();""!==H&&(e.setValue(k=H),l(m,""),h.addClass("has-value"));var t=new zjs.dictionary(a.source,w);a.cacheResponse||t.setCacheResponse(!1);""!=a.sourceUrl&&t.setDataSourceUrl(a.sourceUrl);""!=a.initSourceUrl&&(t.setDataSourceUrl(a.initSourceUrl),""===a.sourceUrl&&t.useCacheDataSource(!0),t.getDataFromDataSource());
""!=a.sourceDataStructure&&t.setDataSourceDataStructure(a.sourceDataStructure);0<a.limit&&t.setDefaultSearchResultLimit(a.limit);a.searchMatchStartWith&&t.setSearchMatchStartWith(!0);b.setData("zjsmoduleautosuggestiondictionary",t);var U=function(){B&&(""===b.getValue()?(k="",l(m,""),e.setValue(""),h.removeClass("has-value")):h.addClass("has-value"));n.addClass("zui-panel-hide");b.trigger("ui:autosuggestion:blur")},D=function(c,f){E&&(a=b.getData("zjsmoduleautosuggestionoption"),E=!1);var d=c.getKeyCode();
38==d||40==d?"keydown"==f&&ia(c,d):37!=d&&(39==d||9==d?("keydown"==f&&ja(),9==d&&(n.addClass("zui-panel-hide"),U())):13==d?a.multichoice?""!=e.getValue("")&&("keydown"==f&&V(),c.preventDefault()):(d=n.hasClass("zui-panel-hide"),"keydown"==f&&V(),a.multiline&&(c.preventDefault(),y(),d&&function(){b.findUp("form").submit()}.delay(1))):27==d?(n.hasClass("zui-panel-hide")||e.setValue(k),"text"===a.usedproperty||a.usedpropertytext?(b.setValue(k),""===k?l(m,x()):l(m,r="")):b.setValue(""),n.addClass("zui-panel-hide"),
v.find(".zui-autosuggestion-item").removeClass("highlight"),z=p=0,a.multiline&&y()):8==d?ka():(P&&"input"==f?L(!0):"keyup"==f&&L(!0),b.trigger("input")))},ia=function(c,f){c.preventDefault();v.find(".zui-autosuggestion-item").removeClass(a.itemhighlightclass);40==f&&p++;38==f&&p--;p>F&&(p=0);0>p&&(p=F);if(0===p){var d=k;l(m,r,k)}else{var g=v.find('.zui-autosuggestion-item[data-highlight="'+p+'"]'),h=g.getData("searchtempdata");g.addClass(a.itemhighlightclass);d=h.text;l(m,"")}e.setValue(d);a.multichoice&&
(e.width(K.setInnerHTML(e.getValue("")).width()+10),n.top(u.height()));h&&a.usedproperty in h?b.setValue(h[a.usedproperty]):("text"==a.usedproperty||a.usedpropertytext)&&b.setValue(k);a.multiline&&y();I.scrollToElement(g);"object"==typeof h&&(b.trigger("ui:autosuggestion:highlight",h),""!=a.itemLinkFormat&&(S=g.getAttr("href")))},ja=function(){if(""!=r&&(e.setValue(k=r),l(m,r=""),0>=p&&(p=z),n.addClass("zui-panel-hide"),!(0>=p))){var c=v.find('.zui-autosuggestion-item[data-highlight="'+p+'"]').getData("searchtempdata");
"object"==typeof c&&(a.multichoice?(e.setValue("").width(10),c&&a.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",c[a.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token"),A())):(a.multiline&&y(),c&&a.usedproperty in c&&(T=c[a.usedproperty],k=c[a.searchproperty],e.setValue(k),b.setValue(T))),q&&q.setValue(c.id),b.trigger("ui:autosuggestion:choice",c))}},V=function(){k=e.getValue("");var c={text:k},f=!1;if((z||p||
!n.hasClass("zui-panel-hide"))&&""!=k){if(0<p)f=v.find('.zui-autosuggestion-item[data-highlight="'+p+'"]');else if(0<z)f=v.find('.zui-autosuggestion-item[data-highlight="'+z+'"]');else if("id"==a.usedproperty){var d=v.find(".zui-autosuggestion-item");0<d.count()&&(f=d.item(0))}f&&(c=f.getData("searchtempdata"))}""!=k&&l(m,r="");n.addClass("zui-panel-hide");"object"==typeof c&&(a.multichoice?(e.setValue("").width(10),k="",c&&a.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",
c[a.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token")),A()):c&&(l(m,r=""),n.addClass("zui-panel-hide"),a.searchproperty in c&&e.setValue(k=c[a.searchproperty]),a.usedproperty in c&&b.setValue(c[a.usedproperty])),q&&q.setValue(c.id),b.trigger("ui:autosuggestion:choice",c),""!=a.itemLinkFormat&&f&&(c=f.getAttr("href"),c==S&&(window.location.href=c)))},ka=function(){a.multichoice&&""==e.getValue("")&&(h.find(".zui-autosuggestion-token").lastChild().remove(),A(),""==b.getValue()&&
(h.removeClass("zui-autosuggestion-with-token"),r="",function(){m.top(e.top()).left(e.left()).show();l(m,x())}.delay(80)))},L=function(c){var f=e.getValue("");k=f;l(m,"");""!==f?h.addClass("has-value"):h.removeClass("has-value");if(a.multichoice){e.width(K.setInnerHTML(f).width()+10);if(""==f){""==b.getValue()?l(m.show(),x()):m.hide();r="";l(m,x());n.addClass("zui-panel-hide");return}m.top(e.top()).left(e.left()).show()}else{a.multiline&&y();"text"==a.usedproperty||a.usedpropertytext?b.setValue(f):
b.setValue("");if(""==f&&B){M();return}if(""==f||c&&f.length<a.minlength){r="";""!=f?l(m,"",f):l(m,x());n.addClass("zui-panel-hide");return}}c&&G&&(p=0,r="",z=0,b.trigger("ui:autosuggestion:beforesearch",{value:f}),b.getData("zjsmoduleautosuggestiondictionary").asyncSearch(f,function(c){b.trigger("ui:autosuggestion:searchresult",{value:f,result:c});k=e.getValue();""===k&&l(m,x());if(0===c.length||""===k)n.addClass("zui-panel-hide");else{F=c.length;n.removeClass("zui-panel-hide").top(u.height());v.setInnerHTML("");
var d=0;zjs.eachItem(c,function(c,b){var e=W(a,v,c,b);d+=e.height();e.hover(X);e.click(Y);if(""==r){e=c.text.toLowerCase();var g=f.toLowerCase();0===e.indexOf(g)&&(r=f+c.text.substr(f.length),z=b+1)}});l(m,r,f);R(d)}}))};b.setData("zjsmoduleautosuggestionkeytype",L);var X=function(c){v.find(".zui-autosuggestion-item").removeClass(a.itemhighlightclass);c=zjs(this).addClass(a.itemhighlightclass).getData("searchtempdata");"object"==typeof c&&b.trigger("ui:autosuggestion:highlight",c)},Y=function(c){c=
zjs(this);var f=c.getData("searchtempdata");"object"==typeof f&&(k=f.text,e.setValue(k),h.addClass("has-value"),a.multichoice?(e.setValue("").width(10),f&&a.usedproperty in f&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(f.text).setAttr("data-value",f[a.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token"),A())):(f&&a.usedproperty in f&&b.setValue(f[a.usedproperty]),a.multiline&&y()),q&&q.setValue(f.id),p=c.getAttr("data-highlight",0).toInt(),l(m,r=""),n.addClass("zui-panel-hide"),
e.focus(),b.trigger("ui:autosuggestion:choice",f))},A=function(){var a=[];h.find(".zui-autosuggestion-token").eachElement(function(c){a.push(zjs(c).getAttr("data-value",""))});b.setValue(a.join(","))},y=function(){J.setInnerHTML(e.getValue());var c=Math.max(J.height(),a.minheight);e.height(c);n.hasClass("zui-panel-hide")||n.top(u.height())};a.multiline&&(zjs(window).on("resize",y),y.delay(1));if(P)e.on("keydown",function(a,b){D(a,"keydown")}).on("input",function(a,b){D(a,"input")});else e.on("keydown",
function(a,b){D(a,"keydown")}).on("keypress",function(a,b){D(a,"keypress")}).on("keyup",function(a,b){D(a,"keyup")}).on("mouseup",function(a,b){D(a,"keyup")});e.on("blur",function(a){U.delay(100)});u.on("click",function(){e.focus()});var N=!1;b.on("focus",function(){N||e.focus()});e.on("focus",function(){h.addClass("focus");N=!0;b.trigger("focus");N=!1}).on("blur",function(){h.removeClass("focus");q&&""===e.getValue().trim()&&q.setValue(a.noneValue);b.trigger("blur")}).on("keyup",function(){b.trigger("keyup")});
a.autofocus&&e.focus();var M=function(){var c=b.getData("zjsmoduleautosuggestiondictionary").getItemsLimit();if(0!=c.length){F=c.length;n.removeClass("zui-panel-hide").top(u.height());v.setInnerHTML("");var d=0;zjs.eachItem(c,function(b,c){var e=W(a,v,b,c);d+=e.height();e.hover(X);e.click(Y)});R(0<a.defaultPanelHeight?a.defaultPanelHeight:d)}};if(a.focusshowsuggestion)u.on("click",function(b){""==k&&(b=b.getTarget(),zjs(b).hasClass("zui-autosuggestion-token")||(0<a.defaultPanelHeight?M(a.defaultPanelHeight):
function(){M()}.delay(100)))});zjs(document).on("click",function(a){a=zjs(a.target()).findUp(".zui-autosuggestion-wrap");if(0<a.count()&&(a=a.find(".zui-autosuggestion-panel-wrap"),0<a.count()&&a.item(0,!0)===n.item(0,!0)))return;n.addClass("zui-panel-hide")});if(a.multichoice)u.on("click",".zui-autosuggestion-token",function(a){this.remove();A();""==b.getValue()&&(h.removeClass("zui-autosuggestion-with-token"),""==k&&(r="",l(m,x())));(function(){m.show().top(e.top()).left(e.left())}).delay(50)});
!a.multichoice||""==k||"id"!=a.usedproperty&&"text"!=a.usedproperty||("id"==a.usedproperty?zjs.eachItem(k.split(/\s*,\s*/),function(b){t.asyncGetItemById(b,function(b){b&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(b.text).setAttr("data-value",b[a.usedproperty]).insertBefore(e),A())})}):"text"==a.usedproperty&&zjs.eachItem(k.split(/\s*,\s*/),function(b){t.asyncSearch(b,function(b){0>=b.length||(b=b[0],zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(b.text).setAttr("data-value",
b[a.usedproperty]).insertBefore(e),A())})}),h.addClass("zui-autosuggestion-with-token"),e.setValue(k=""),m.hide())}},W=function(d,g,b,a){if(""!=d.itemLinkFormat){var l=zjs.isFunction(d.itemLinkFormat)?d.itemLinkFormat(b):d.itemLinkFormat;l=zjs('<a class="zui-autosuggestion-item"></a>').setAttr("href",l.format(b))}else l=zjs('<div class="zui-autosuggestion-item"></div>');l.appendTo(g);l.setData("searchtempdata",b);l.setAttr("data-highlight",a+1);g="";"function"==typeof d.itemtemplate&&(g=d.itemtemplate(b));
"string"==typeof d.itemtemplate&&(g=d.itemtemplate);"string"==typeof g&&(g=g.format(b));zjs(g).appendTo(l);return l},l=function(d,g,b){g=g||"";(b=b||"")&&g&&(g='<span class="_hide">'+g.substr(0,b.length)+"</span>"+g.substr(b.length));d.setInnerHTML(g)};zjs.extendMethod({isAutosuggestion:function(){return!!zjs(this.item(0,1)).getData("zjsmoduleautosuggestiondictionary")},makeAutosuggestion:function(d){return this.eachElement(function(g){O(g,d)})},autosuggestionAddindex:function(d){return this.eachElement(function(g){var b=
zjs(g);g=b.getData("zjsmoduleautosuggestiondictionary");b=b.getData("zjsmoduleautosuggestionoption");g&&g.addIndex(d,b.searchproperty)})},autosuggestionRemoveindex:function(d,g){return this.eachElement(function(b){(b=zjs(b).getData("zjsmoduleautosuggestiondictionary"))&&b.removeIndex(d,g)})},autosuggestionResetIndex:function(){return this.eachElement(function(d){(d=zjs(d).getData("zjsmoduleautosuggestiondictionary"))&&d.resetIndex()})},autosuggestionFocus:function(){return this.eachElement(function(d){d=
zjs(d);var g=d.getData("zmoduleautosuggestionwrapinputel");g?g.trigger("click"):d.focus()})},autosuggestionSetValue:function(d,g){d=d||"";return this.eachElement(function(b){var a=zjs(b).getData("zjsmoduleautosuggestionnewinput");if(a)try{a.value=d,zjs(b).getData("zjsmoduleautosuggestionkeytype")(g||!1)}catch(E){}else zjs(b).setValue(d)})},autosuggestionDisable:function(d){d=d||!1;return this.eachElement(function(g){var b=zjs(g).getData("zjsmoduleautosuggestionnewinput");g=zjs(g).getData("zmoduleautosuggestionwrapel");
if(b)try{(b.disabled=d)?g.addClass("disabled"):g.removeClass("disabled")}catch(a){}})}});zjs.hook({after_setInnerHTML:function(d){zjs(d).find(".zautosuggestion").makeAutosuggestion()},after_insertDOM:function(d){zjs(d).is(".zautosuggestion")&&zjs(d).makeAutosuggestion();zjs(d).find(".zautosuggestion").makeAutosuggestion()}});zjs(function(){zjs(".zautosuggestion").makeAutosuggestion()});"required"in zjs&&zjs.required("ui.autosuggestion")});