zjs.require("dictionary, scrollbar",function(){zjs.extendCore({moduleUiAutosuggestionOption:{minlength:1,minheight:18,customcss:!0,focusshowsuggestion:!1,autofocus:!1,panelmaxheight:200,multiline:!0,multichoice:!1,mentionmode:!1,usedproperty:"text",searchproperty:"text",noneValue:"",source:[],sourceUrl:"",initSourceUrl:"",sourceDataStructure:"",itemtemplate:'<div class="item">${text}</div>',itemLinkFormat:"",itemhighlightclass:"highlight"}});var I=function(g,d){var b=zjs(g),a=b.getData("zjsmoduleautosuggestionoption"),
D=!1;if(a)b.setData("zjsmoduleautosuggestionoption",zjs.extend(a,d)),D=!0;else{var a=zjs.clone(zjs.moduleUiAutosuggestionOption),z=b.getAttr("data-option","");zjs.isString(z)&&""!=z.trim()&&(a=zjs.extend(a,z.jsonDecode()));b.removeAttr("data-option");"undefined"!=typeof d&&(a=zjs.extend(a,d));var r=!1;zjs.isString(a.source)&&(r=zjs(a.source),0<r.count()?(a.multichoice=!1,a.usedproperty="id.text",a.source={},r.find("option").eachElement(function(c,f){var e=zjs(c).getValue(),d=zjs(c).getInnerText();
e!==a.noneValue&&(a.source[e]=d,0===f&&e!=a.noneValue&&b.setValue(e),c.selected&&e!=a.noneValue&&b.setValue(d))}),r.hide()):r=!1);z=a.searchproperty;"id.text"==a.usedproperty&&(a.searchproperty="text",a.usedproperty="id",z="id.text");a.mentionmode&&(a.multichoice=!1);a.multichoice&&(a.multiline=!1);b.setData("zjsmoduleautosuggestionoption",a);var h=zjs('<div class="zui-autosuggestion-wrap"><div class="zui-autosuggestion-inputwrap"><div class="zui-autosuggestion-placeholder"></div><input class="zui-autosuggestion-input" autocomplete="off" /><textarea class="zui-autosuggestion-input" autocomplete="off"></textarea><div class="zui-autosuggestion-input-test-wrap"><div class="zui-autosuggestion-input-test"></div></div><div class="zui-estimate-height-wrap"><div class="zui-autosuggestion-input zui-estimate-height"></div></div></div><div class="zui-autosuggestion-panel-wrap zui-panel-hide"><div class="zui-autosuggestion-panel-scroll"><div class="zui-autosuggestion-panel-content"></div></div></div></div>');
a.multiline?h.find("input.zui-autosuggestion-input").remove():h.find("textarea.zui-autosuggestion-input").remove();b.setData("zmoduleautosuggestionwrapel",h);h.insertAfter(b);var u=h.find(".zui-autosuggestion-inputwrap"),k=h.find(".zui-autosuggestion-placeholder"),e=h.find("input.zui-autosuggestion-input,textarea.zui-autosuggestion-input"),m=h.find(".zui-autosuggestion-panel-wrap"),E=h.find(".zui-autosuggestion-panel-scroll"),t=h.find(".zui-autosuggestion-panel-content"),F=!1;b.setData("zmoduleautosuggestionwrapinputel",
u);b.setData("zjsmoduleautosuggestionnewinput",e.item(0,!0));a.multiline?(F=h.find(".zui-estimate-height"),h.addClass("multiline")):h.find(".zui-estimate-height-wrap").remove();b.on("focus",function(){e.focus()});e.on("focus",function(){h.addClass("focus")}).on("blur",function(){h.removeClass("focus");r&&""===e.getValue().trim()&&r.setValue(a.noneValue)});a.autofocus&&e.focus();if(!a.customcss){var G=b.width(),J=b.height();b.getStyle("margin-left",!0);b.getStyle("margin-right",!0);b.getStyle("margin-top",
!0);b.getStyle("margin-bottom",!0);var I=b.getStyle("padding-left",!0),S=b.getStyle("padding-right",!0),T=b.getStyle("padding-top",!0),U=b.getStyle("padding-bottom",!0),V=b.getStyle("border-left-width",!0),W=b.getStyle("border-right-width",!0),X=b.getStyle("border-top-width",!0),Y=b.getStyle("border-bottom",!0),Z=b.getStyle("font");"content-box"==b.getStyle("box-sizing")&&(G-=I+S+V+W,J-=T+U+X+Y);u.copyStyleFrom(b);u.setStyle({position:"relative",cursor:"text",width:G,height:J,"-webkit-text-fill-color":"initial"});
e.setStyle({top:k.top(),font:Z,width:G})}var H=!1;a.multichoice?(h.addClass("zui-autosuggestion-multi-wrap"),H=h.find(".zui-autosuggestion-input-test").setStyle({margin:e.getStyle("margin"),padding:e.getStyle("padding"),font:e.getStyle("font"),border:e.getStyle("border")})):h.find(".zui-autosuggestion-input-test-wrap").remove();m.height(a.panelmaxheight);E.makeScrollbar({bounce:!1,usecss:!1,usekey:!1,customCssClass:"zui-autosuggestion-panel"});m.addClass("zui-panel-hide");var K=function(c){c=Math.min(c,
a.panelmaxheight);m.height(c);E.scrollHeight(c).scrollToTop()},L="",A=b.getAttr("placeholder"),p=0,C=0,n="",q="",x=0,M="";l(k,A);b.setAttr({type:"hidden",autocomplete:"off"});""!=b.getValue("")&&(e.setValue(n=b.getValue()),l(k,""));var v=new zjs.dictionary(a.source,z);""!=a.sourceUrl&&v.setDataSourceUrl(a.sourceUrl);""!=a.initSourceUrl&&(v.setDataSourceUrl(a.initSourceUrl),v.useCacheDataSource(!0),v.getDataFromDataSource());""!=a.sourceDataStructure&&v.setDataSourceDataStructure(a.sourceDataStructure);
b.setData("zjsmoduleautosuggestiondictionary",v);var B=function(c,f){D&&(a=b.getData("zjsmoduleautosuggestionoption"),D=!1);var d=c.getKeyCode();38==d||40==d?"keydown"==f&&aa(c,d):37!=d&&(39==d||9==d?("keydown"==f&&ba(),9==d&&(m.addClass("zui-panel-hide"),b.trigger("ui:autosuggestion:blur"))):13==d?a.multichoice?""!=e.getValue("")&&("keydown"==f&&N(),c.preventDefault()):(d=m.hasClass("zui-panel-hide"),"keydown"==f&&N(),a.multiline&&(c.preventDefault(),w(),d&&function(){b.findUp("form").submit()}.delay(1))):
27==d?(m.hasClass("zui-panel-hide")||e.setValue(n),b.setValue("text"==a.usedproperty?n:""),l(k,q=""),m.addClass("zui-panel-hide"),t.find(".zui-autosuggestion-item").removeClass("highlight"),x=p=0,a.multiline&&w()):8==d?ca():O("keyup"==f||"input"==f))},aa=function(c,f){c.preventDefault();t.find(".zui-autosuggestion-item").removeClass(a.itemhighlightclass);40==f&&p++;38==f&&p--;p>C&&(p=0);0>p&&(p=C);if(0==p){var d=n;l(k,q)}else{var g=t.find('.zui-autosuggestion-item[data-highlight="'+p+'"]');var h=
g.getData("searchtempdata");g.addClass(a.itemhighlightclass);d=h.text;l(k,"")}e.setValue(d);a.multichoice&&(e.width(H.setInnerHTML(e.getValue("")).width()+10),m.top(u.height()));h&&a.usedproperty in h&&b.setValue(h[a.usedproperty]);a.multiline&&w();E.scrollToElement(g);"object"==typeof h&&(b.trigger("ui:autosuggestion:highlight",h),""!=a.itemLinkFormat&&(L=g.getAttr("href")))},ba=function(){if(""!=q&&(e.setValue(n=q),l(k,q=""),0>=p&&(p=x),m.addClass("zui-panel-hide"),!(0>=p))){var c=t.find('.zui-autosuggestion-item[data-highlight="'+
p+'"]').getData("searchtempdata");"object"==typeof c&&(a.multichoice?(e.setValue("").width(10),c&&a.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",c[a.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token"),y())):(a.multiline&&w(),c&&a.usedproperty in c&&(M=c[a.usedproperty],n=c[a.searchproperty],b.setValue(M))),r&&r.setValue(c.id),b.trigger("ui:autosuggestion:choice",c))}},N=function(){n=e.getValue("");var c={text:n},
f=!1;if((x||p||!m.hasClass("zui-panel-hide"))&&""!=n){if(0<p)f=t.find('.zui-autosuggestion-item[data-highlight="'+p+'"]');else if(0<x)f=t.find('.zui-autosuggestion-item[data-highlight="'+x+'"]');else if("text"!=a.usedproperty){var d=t.find(".zui-autosuggestion-item");0<d.count()&&(f=d.item(0))}f&&(c=f.getData("searchtempdata"))}""!=n&&l(k,q="");m.addClass("zui-panel-hide");"object"==typeof c&&(a.multichoice?(e.setValue("").width(10),n="",c&&a.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",
c[a.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token")),y()):c&&(l(k,q=""),m.addClass("zui-panel-hide"),a.searchproperty in c&&e.setValue(n=c[a.searchproperty]),a.usedproperty in c&&b.setValue(c[a.usedproperty])),r&&r.setValue(c.id),b.trigger("ui:autosuggestion:choice",c),""!=a.itemLinkFormat&&f&&(c=f.getAttr("href"),c==L&&(window.location.href=c)))},ca=function(){a.multichoice&&""==e.getValue("")&&(h.find(".zui-autosuggestion-token").lastChild().remove(),y(),""==b.getValue()&&
(h.removeClass("zui-autosuggestion-with-token"),q="",function(){k.top(e.top()).left(e.left()).show();l(k,A)}.delay(80)))},O=function(c){var f=e.getValue("");n=f;if(a.multichoice){e.width(H.setInnerHTML(f).width()+10);if(""==f){""==b.getValue()?l(k.show(),A):k.hide();q="";l(k,A);m.addClass("zui-panel-hide");return}k.top(e.top()).left(e.left()).show()}else if(a.multiline&&w(),b.setValue("text"==a.usedproperty?f:""),""==f||f.length<a.minlength){q="";""!=f?l(k,""):l(k,A,f);m.addClass("zui-panel-hide");
return}c&&(p=0,q="",x=0,b.getData("zjsmoduleautosuggestiondictionary").asyncSearch(f,function(c){if(0==c.length||""==e.getValue())l(k,""),m.addClass("zui-panel-hide");else{C=c.length;m.removeClass("zui-panel-hide").top(u.height());t.setInnerHTML("");var b=0;zjs.eachItem(c,function(c,d){var e=P(a,t,c,d);b+=e.height();e.hover(Q);e.click(R);""==q&&0==c.text.indexOf(f)&&(q=c.text,x=d+1)});l(k,q,f);K(b)}}))};b.setData("zjsmoduleautosuggestionkeytype",O);var Q=function(c){t.find(".zui-autosuggestion-item").removeClass(a.itemhighlightclass);
c=zjs(this).addClass(a.itemhighlightclass).getData("searchtempdata");"object"==typeof c&&b.trigger("ui:autosuggestion:highlight",c)},R=function(c){c=zjs(this);var f=c.getData("searchtempdata");"object"==typeof f&&(n=f.text,e.setValue(n),a.multichoice?(e.setValue("").width(10),f&&a.usedproperty in f&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(f.text).setAttr("data-value",f[a.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token"),y())):(f&&a.usedproperty in
f&&b.setValue(f[a.usedproperty]),a.multiline&&w()),r&&r.setValue(f.id),p=c.getAttr("data-highlight",0).toInt(),l(k,q=""),m.addClass("zui-panel-hide"),e.focus(),b.trigger("ui:autosuggestion:choice",f))},y=function(){var a=[];h.find(".zui-autosuggestion-token").eachElement(function(c){a.push(zjs(c).getAttr("data-value",""))});b.setValue(a.join(","))},w=function(){F.setInnerHTML(e.getValue());var c=Math.max(F.height(),a.minheight);e.height(c);m.hasClass("zui-panel-hide")||m.top(u.height())};a.multiline&&
(zjs(window).on("resize",w),w.delay(1));if("oninput"in document.createElement("input"))e.on("keydown",function(a,b){B(a,"keydown")}).on("input",function(a,b){B(a,"input")});else e.on("keydown",function(a,b){B(a,"keydown")}).on("keypress",function(a,b){B(a,"keypress")}).on("keyup",function(a,b){B(a,"keyup")}).on("mouseup",function(a,b){B(a,"keyup")});e.on("blur",function(a){b.trigger("ui:autosuggestion:blur")});u.on("click",function(){e.focus()});if(a.focusshowsuggestion)u.on("click",function(c){""==
n&&(c=c.getTarget(),zjs(c).hasClass("zui-autosuggestion-token")||function(){var c=b.getData("zjsmoduleautosuggestiondictionary").search("");if(0!=c.length){C=c.length;m.removeClass("zui-panel-hide").top(u.height());t.setInnerHTML("");var d=0;zjs.eachItem(c,function(b,c){var e=P(a,t,b,c);d+=e.height();e.hover(Q);e.click(R)});K(d)}}.delay(100))});zjs(document).on("click",function(a){m.addClass("zui-panel-hide")});if(a.multichoice)u.on("click",".zui-autosuggestion-token",function(a){this.remove();y();
""==b.getValue()&&(h.removeClass("zui-autosuggestion-with-token"),""==n&&(q="",l(k,A)));(function(){k.show().top(e.top()).left(e.left())}).delay(50)});!a.multichoice||""==n||"id"!=a.usedproperty&&"text"!=a.usedproperty||("id"==a.usedproperty?zjs.eachItem(n.split(/\s*,\s*/),function(b){v.asyncGetItemById(b,function(b){b&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(b.text).setAttr("data-value",b[a.usedproperty]).insertBefore(e),y())})}):"text"==a.usedproperty&&zjs.eachItem(n.split(/\s*,\s*/),
function(b){v.asyncSearch(b,function(b){0>=b.length||(b=b[0],zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(b.text).setAttr("data-value",b[a.usedproperty]).insertBefore(e),y())})}),h.addClass("zui-autosuggestion-with-token"),e.setValue(n=""),k.hide())}},P=function(g,d,b,a){var l=""!=g.itemLinkFormat?zjs('<a class="zui-autosuggestion-item"></a>').setAttr("href",g.itemLinkFormat.format(b)):zjs('<div class="zui-autosuggestion-item"></div>');l.appendTo(d);l.setData("searchtempdata",
b);l.setAttr("data-highlight",a+1);d="";"function"==typeof g.itemtemplate&&(d=g.itemtemplate(b));"string"==typeof g.itemtemplate&&(d=g.itemtemplate);"string"==typeof d&&(d=d.format(b));zjs(d).appendTo(l);return l},l=function(g,d,b){d=d||"";(b=b||"")&&d&&(d=d.replace(b,'<span class="_hide">'+b+"</span>"));g.setInnerHTML(d)};zjs.extendMethod({makeAutosuggestion:function(g){return this.eachElement(function(d){I(d,g)})},autosuggestionAddindex:function(g){return this.eachElement(function(d){var b=zjs(d);
d=b.getData("zjsmoduleautosuggestiondictionary");b=b.getData("zjsmoduleautosuggestionoption");d&&d.addIndex(g,b.searchproperty)})},autosuggestionRemoveindex:function(g,d){return this.eachElement(function(b){(b=zjs(b).getData("zjsmoduleautosuggestiondictionary"))&&b.removeIndex(g,d)})},autosuggestionFocus:function(){return this.eachElement(function(g){(g=zjs(g).getData("zmoduleautosuggestionwrapinputel"))&&g.trigger("click")})},autosuggestionSetValue:function(g){"undefined"==typeof g&&(g="");return this.eachElement(function(d){var b=
zjs(d).getData("zjsmoduleautosuggestionnewinput");if(b)try{b.value=g,zjs(d).getData("zjsmoduleautosuggestionkeytype")(!0)}catch(a){}})},autosuggestionDisable:function(g){g=g||!1;return this.eachElement(function(d){var b=zjs(d).getData("zjsmoduleautosuggestionnewinput");d=zjs(d).getData("zmoduleautosuggestionwrapel");if(b)try{(b.disabled=g)?d.addClass("disabled"):d.removeClass("disabled")}catch(a){}})}});zjs.hook({after_setInnerHTML:function(g){zjs(g).find(".zautosuggestion").makeAutosuggestion()},
after_insertDOM:function(g){zjs(g).is(".zautosuggestion")&&zjs(g).makeAutosuggestion();zjs(g).find(".zautosuggestion").makeAutosuggestion()}});zjs(function(){zjs(".zautosuggestion").makeAutosuggestion()});"required"in zjs&&zjs.required("ui.autosuggestion")});