zjs.require("dictionary, scrollbar",function(){zjs.extendCore({moduleUiAutosuggestionOption:{minlength:1,minheight:18,customcss:!0,labelPlaceholder:!1,focusshowsuggestion:!1,autofocus:!1,panelmaxheight:200,multiline:!0,multichoice:!1,mentionmode:!1,usedproperty:"text",searchproperty:"text",usedpropertytext:!1,noneValue:"",source:[],sourceUrl:"",initSourceUrl:"",sourceDataStructure:"",cacheResponse:!0,itemtemplate:'<div class="item">${text}</div>',itemLinkFormat:"",itemhighlightclass:"highlight"}});
var M="oninput"in document.createElement("input"),L=function(d,g){var a=zjs(d),b=a.getData("zjsmoduleautosuggestionoption"),D=!1;if(b)a.setData("zjsmoduleautosuggestionoption",zjs.extend(b,g)),D=!0;else{var F=!0;b=zjs.clone(zjs.moduleUiAutosuggestionOption);var w=a.getAttr("data-option","");zjs.isString(w)&&""!=w.trim()&&(b=zjs.extend(b,w.jsonDecode()));a.removeAttr("data-option");b.sourceUrl||(w=a.getAttr("data-autocomplete-path",""),""!==w&&(b.sourceUrl=w));zjs.hook({after_setAttr:function(c,f,
e){c===d&&"data-autocomplete-path"===f&&(c=a.getAttr("data-autocomplete-path",""),""==c?F=!1:(F=!0,b.sourceUrl=c,v.setDataSourceUrl(b.sourceUrl)))}});"undefined"!=typeof g&&(b=zjs.extend(b,g));var r=!1;if(zjs.isString(b.source)||a.is("select"))r=zjs.isString(b.source)?zjs(b.source):a,0<r.count()?(b.multichoice=!1,b.usedproperty="id.text",b.source={},r.find("option").eachElement(function(c,f){var e=zjs(c).getValue(),d=zjs(c).getInnerText();e!==b.noneValue&&(b.source[e]=d,0===f&&e!=b.noneValue&&a.setValue(e),
c.selected&&e!=b.noneValue&&a.setValue(d))}),r.hide(),zjs.isString(b.source)&&r.removeAttr("required").removeClass("required")):r=!1;a.is("select")&&(b.focusshowsuggestion=!0);w=b.searchproperty;"id.text"==b.usedproperty&&(b.searchproperty="text",b.usedproperty="id",w="id.text");b.mentionmode&&(b.multichoice=!1);b.multichoice&&(b.multiline=!1);a.setData("zjsmoduleautosuggestionoption",b);var h=zjs('<div class="zui-autosuggestion-wrap"><div class="zui-autosuggestion-inputwrap"><div class="zui-autosuggestion-placeholder"></div><input class="zui-autosuggestion-input" autocomplete="off" /><textarea class="zui-autosuggestion-input" autocomplete="off"></textarea><div class="zui-autosuggestion-input-test-wrap"><div class="zui-autosuggestion-input-test"></div></div><div class="zui-estimate-height-wrap"><div class="zui-autosuggestion-input zui-estimate-height"></div></div></div><div class="zui-autosuggestion-panel-wrap zui-panel-hide"><div class="zui-autosuggestion-panel-scroll"><div class="zui-autosuggestion-panel-content"></div></div></div></div>');
b.multiline?h.find("input.zui-autosuggestion-input").remove():h.find("textarea.zui-autosuggestion-input").remove();a.setData("zmoduleautosuggestionwrapel",h);h.insertAfter(a);var t=h.find(".zui-autosuggestion-inputwrap"),m=h.find(".zui-autosuggestion-placeholder"),e=h.find("input.zui-autosuggestion-input,textarea.zui-autosuggestion-input"),n=h.find(".zui-autosuggestion-panel-wrap"),G=h.find(".zui-autosuggestion-panel-scroll"),u=h.find(".zui-autosuggestion-panel-content"),H=!1;e.setAttr("autocomplete",
Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10));a.setData("zmoduleautosuggestionwrapinputel",t);a.setData("zjsmoduleautosuggestionnewinput",e.item(0,!0));b.multiline?(H=h.find(".zui-estimate-height"),h.addClass("multiline")):h.find(".zui-estimate-height-wrap").remove();if(!b.customcss){var B=a.width(),N=a.height();a.getStyle("margin-left",!0);a.getStyle("margin-right",!0);a.getStyle("margin-top",!0);a.getStyle("margin-bottom",!0);var L=a.getStyle("padding-left",!0),W=a.getStyle("padding-right",
!0),X=a.getStyle("padding-top",!0),Y=a.getStyle("padding-bottom",!0),Z=a.getStyle("border-left-width",!0),aa=a.getStyle("border-right-width",!0),ba=a.getStyle("border-top-width",!0),ca=a.getStyle("border-bottom",!0),da=a.getStyle("font");"content-box"==a.getStyle("box-sizing")&&(B-=L+W+Z+aa,N-=X+Y+ba+ca);t.copyStyleFrom(a);t.setStyle({position:"relative",cursor:"text",width:B,height:N,"-webkit-text-fill-color":"initial"});e.setStyle({top:m.top(),font:da,width:B})}var I=!1;b.multichoice?(h.addClass("zui-autosuggestion-multi-wrap"),
I=h.find(".zui-autosuggestion-input-test").setStyle({margin:e.getStyle("margin"),padding:e.getStyle("padding"),font:e.getStyle("font"),border:e.getStyle("border")})):h.find(".zui-autosuggestion-input-test-wrap").remove();n.height(b.panelmaxheight);G.makeScrollbar({bounce:!1,usecss:!1,usekey:!1,customCssClass:"zui-autosuggestion-panel",autoUseDefaultWithMobile:!0});n.addClass("zui-panel-hide");var O=function(a){a=Math.min(a,b.panelmaxheight);n.height(a);G.scrollHeight(a).scrollToTop()},P="",x=function(){return a.getAttr("data-placeholder",
a.getAttr("placeholder",""))},p=0,E=0,l="",q="",z=0,Q="";B=x();b.labelPlaceholder&&""!==B&&(zjs("<span>").addClass("placeholder").html(B).insertAfter(t),t.addClass("label-placeholder"));k(m,x());a.hide();""!=a.getValue("")&&(e.setValue(l=a.getValue()),k(m,""));var v=new zjs.dictionary(b.source,w);b.cacheResponse||v.setCacheResponse(!1);""!=b.sourceUrl&&v.setDataSourceUrl(b.sourceUrl);""!=b.initSourceUrl&&(v.setDataSourceUrl(b.initSourceUrl),""===b.sourceUrl&&v.useCacheDataSource(!0),v.getDataFromDataSource());
""!=b.sourceDataStructure&&v.setDataSourceDataStructure(b.sourceDataStructure);a.setData("zjsmoduleautosuggestiondictionary",v);var R=function(){a.is("select")&&""===a.getValue()&&(k(m,""),e.setValue(""),h.removeClass("has-value"));a.trigger("ui:autosuggestion:blur")},C=function(c,f){D&&(b=a.getData("zjsmoduleautosuggestionoption"),D=!1);var d=c.getKeyCode();38==d||40==d?"keydown"==f&&ea(c,d):37!=d&&(39==d||9==d?("keydown"==f&&fa(),9==d&&(n.addClass("zui-panel-hide"),R())):13==d?b.multichoice?""!=
e.getValue("")&&("keydown"==f&&S(),c.preventDefault()):(d=n.hasClass("zui-panel-hide"),"keydown"==f&&S(),b.multiline&&(c.preventDefault(),y(),d&&function(){a.findUp("form").submit()}.delay(1))):27==d?(n.hasClass("zui-panel-hide")||e.setValue(l),"text"===b.usedproperty||b.usedpropertytext?(a.setValue(l),""===l?k(m,x()):k(m,q="")):a.setValue(""),n.addClass("zui-panel-hide"),u.find(".zui-autosuggestion-item").removeClass("highlight"),z=p=0,b.multiline&&y()):8==d?ha():(M&&"input"==f?J(!0):"keyup"==f&&
J(!0),a.trigger("input")))},ea=function(c,f){c.preventDefault();u.find(".zui-autosuggestion-item").removeClass(b.itemhighlightclass);40==f&&p++;38==f&&p--;p>E&&(p=0);0>p&&(p=E);if(0===p){var d=l;k(m,q,l)}else{var g=u.find('.zui-autosuggestion-item[data-highlight="'+p+'"]'),h=g.getData("searchtempdata");g.addClass(b.itemhighlightclass);d=h.text;k(m,"")}e.setValue(d);b.multichoice&&(e.width(I.setInnerHTML(e.getValue("")).width()+10),n.top(t.height()));h&&b.usedproperty in h?a.setValue(h[b.usedproperty]):
("text"==b.usedproperty||b.usedpropertytext)&&a.setValue(l);b.multiline&&y();G.scrollToElement(g);"object"==typeof h&&(a.trigger("ui:autosuggestion:highlight",h),""!=b.itemLinkFormat&&(P=g.getAttr("href")))},fa=function(){if(""!=q&&(e.setValue(l=q),k(m,q=""),0>=p&&(p=z),n.addClass("zui-panel-hide"),!(0>=p))){var c=u.find('.zui-autosuggestion-item[data-highlight="'+p+'"]').getData("searchtempdata");"object"==typeof c&&(b.multichoice?(e.setValue("").width(10),c&&b.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",
c[b.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token"),A())):(b.multiline&&y(),c&&b.usedproperty in c&&(Q=c[b.usedproperty],l=c[b.searchproperty],e.setValue(l),a.setValue(Q))),r&&r.setValue(c.id),a.trigger("ui:autosuggestion:choice",c))}},S=function(){l=e.getValue("");var c={text:l},f=!1;if((z||p||!n.hasClass("zui-panel-hide"))&&""!=l){if(0<p)f=u.find('.zui-autosuggestion-item[data-highlight="'+p+'"]');else if(0<z)f=u.find('.zui-autosuggestion-item[data-highlight="'+z+'"]');
else if("id"==b.usedproperty){var d=u.find(".zui-autosuggestion-item");0<d.count()&&(f=d.item(0))}f&&(c=f.getData("searchtempdata"))}""!=l&&k(m,q="");n.addClass("zui-panel-hide");"object"==typeof c&&(b.multichoice?(e.setValue("").width(10),l="",c&&b.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",c[b.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token")),A()):c&&(k(m,q=""),n.addClass("zui-panel-hide"),b.searchproperty in
c&&e.setValue(l=c[b.searchproperty]),b.usedproperty in c&&a.setValue(c[b.usedproperty])),r&&r.setValue(c.id),a.trigger("ui:autosuggestion:choice",c),""!=b.itemLinkFormat&&f&&(c=f.getAttr("href"),c==P&&(window.location.href=c)))},ha=function(){b.multichoice&&""==e.getValue("")&&(h.find(".zui-autosuggestion-token").lastChild().remove(),A(),""==a.getValue()&&(h.removeClass("zui-autosuggestion-with-token"),q="",function(){m.top(e.top()).left(e.left()).show();k(m,x())}.delay(80)))},J=function(c){var f=
e.getValue("");l=f;k(m,"");""!==f?h.addClass("has-value"):h.removeClass("has-value");if(b.multichoice){e.width(I.setInnerHTML(f).width()+10);if(""==f){""==a.getValue()?k(m.show(),x()):m.hide();q="";k(m,x());n.addClass("zui-panel-hide");return}m.top(e.top()).left(e.left()).show()}else if(b.multiline&&y(),"text"==b.usedproperty||b.usedpropertytext?a.setValue(f):a.setValue(""),""==f||c&&f.length<b.minlength){q="";""!=f?k(m,"",f):k(m,x());n.addClass("zui-panel-hide");return}c&&F&&(p=0,q="",z=0,a.trigger("ui:autosuggestion:beforesearch",
{value:f}),a.getData("zjsmoduleautosuggestiondictionary").asyncSearch(f,function(c){a.trigger("ui:autosuggestion:searchresult",{value:f,result:c});l=e.getValue();""===l&&k(m,x());if(0===c.length||""===l)n.addClass("zui-panel-hide");else{E=c.length;n.removeClass("zui-panel-hide").top(t.height());u.setInnerHTML("");var d=0;zjs.eachItem(c,function(a,c){var e=T(b,u,a,c);d+=e.height();e.hover(U);e.click(V);""==q&&0==a.text.indexOf(f)&&(q=a.text,z=c+1)});k(m,q,f);O(d)}}))};a.setData("zjsmoduleautosuggestionkeytype",
J);var U=function(c){u.find(".zui-autosuggestion-item").removeClass(b.itemhighlightclass);c=zjs(this).addClass(b.itemhighlightclass).getData("searchtempdata");"object"==typeof c&&a.trigger("ui:autosuggestion:highlight",c)},V=function(c){c=zjs(this);var f=c.getData("searchtempdata");"object"==typeof f&&(l=f.text,e.setValue(l),h.addClass("has-value"),b.multichoice?(e.setValue("").width(10),f&&b.usedproperty in f&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(f.text).setAttr("data-value",
f[b.usedproperty]).insertBefore(e),h.addClass("zui-autosuggestion-with-token"),A())):(f&&b.usedproperty in f&&a.setValue(f[b.usedproperty]),b.multiline&&y()),r&&r.setValue(f.id),p=c.getAttr("data-highlight",0).toInt(),k(m,q=""),n.addClass("zui-panel-hide"),e.focus(),a.trigger("ui:autosuggestion:choice",f))},A=function(){var b=[];h.find(".zui-autosuggestion-token").eachElement(function(a){b.push(zjs(a).getAttr("data-value",""))});a.setValue(b.join(","))},y=function(){H.setInnerHTML(e.getValue());var a=
Math.max(H.height(),b.minheight);e.height(a);n.hasClass("zui-panel-hide")||n.top(t.height())};b.multiline&&(zjs(window).on("resize",y),y.delay(1));if(M)e.on("keydown",function(b,a){C(b,"keydown")}).on("input",function(b,a){C(b,"input")});else e.on("keydown",function(b,a){C(b,"keydown")}).on("keypress",function(b,a){C(b,"keypress")}).on("keyup",function(b,a){C(b,"keyup")}).on("mouseup",function(b,a){C(b,"keyup")});e.on("blur",function(b){R()});t.on("click",function(){e.focus()});var K=!1;a.on("focus",
function(){K||e.focus()});e.on("focus",function(){h.addClass("focus");K=!0;a.trigger("focus");K=!1}).on("blur",function(){h.removeClass("focus");r&&""===e.getValue().trim()&&r.setValue(b.noneValue);a.trigger("blur")}).on("keyup",function(){a.trigger("keyup")});b.autofocus&&e.focus();if(b.focusshowsuggestion)t.on("click",function(c){""==l&&(c=c.getTarget(),zjs(c).hasClass("zui-autosuggestion-token")||function(){var c=a.getData("zjsmoduleautosuggestiondictionary").search("");if(0!=c.length){E=c.length;
n.removeClass("zui-panel-hide").top(t.height());u.setInnerHTML("");var d=0;zjs.eachItem(c,function(a,c){var e=T(b,u,a,c);d+=e.height();e.hover(U);e.click(V)});O(d)}}.delay(100))});zjs(document).on("click",function(b){n.addClass("zui-panel-hide")});if(b.multichoice)t.on("click",".zui-autosuggestion-token",function(b){this.remove();A();""==a.getValue()&&(h.removeClass("zui-autosuggestion-with-token"),""==l&&(q="",k(m,x())));(function(){m.show().top(e.top()).left(e.left())}).delay(50)});!b.multichoice||
""==l||"id"!=b.usedproperty&&"text"!=b.usedproperty||("id"==b.usedproperty?zjs.eachItem(l.split(/\s*,\s*/),function(a){v.asyncGetItemById(a,function(a){a&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(a.text).setAttr("data-value",a[b.usedproperty]).insertBefore(e),A())})}):"text"==b.usedproperty&&zjs.eachItem(l.split(/\s*,\s*/),function(a){v.asyncSearch(a,function(a){0>=a.length||(a=a[0],zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(a.text).setAttr("data-value",
a[b.usedproperty]).insertBefore(e),A())})}),h.addClass("zui-autosuggestion-with-token"),e.setValue(l=""),m.hide())}},T=function(d,g,a,b){if(""!=d.itemLinkFormat){var k=zjs.isFunction(d.itemLinkFormat)?d.itemLinkFormat(a):d.itemLinkFormat;k=zjs('<a class="zui-autosuggestion-item"></a>').setAttr("href",k.format(a))}else k=zjs('<div class="zui-autosuggestion-item"></div>');k.appendTo(g);k.setData("searchtempdata",a);k.setAttr("data-highlight",b+1);g="";"function"==typeof d.itemtemplate&&(g=d.itemtemplate(a));
"string"==typeof d.itemtemplate&&(g=d.itemtemplate);"string"==typeof g&&(g=g.format(a));zjs(g).appendTo(k);return k},k=function(d,g,a){g=g||"";(a=a||"")&&g&&(g=g.replace(a,'<span class="_hide">'+a+"</span>"));d.setInnerHTML(g)};zjs.extendMethod({isAutosuggestion:function(){return!!zjs(this.item(0,1)).getData("zjsmoduleautosuggestiondictionary")},makeAutosuggestion:function(d){return this.eachElement(function(g){L(g,d)})},autosuggestionAddindex:function(d){return this.eachElement(function(g){var a=
zjs(g);g=a.getData("zjsmoduleautosuggestiondictionary");a=a.getData("zjsmoduleautosuggestionoption");g&&g.addIndex(d,a.searchproperty)})},autosuggestionRemoveindex:function(d,g){return this.eachElement(function(a){(a=zjs(a).getData("zjsmoduleautosuggestiondictionary"))&&a.removeIndex(d,g)})},autosuggestionResetIndex:function(){return this.eachElement(function(d){(d=zjs(d).getData("zjsmoduleautosuggestiondictionary"))&&d.resetIndex()})},autosuggestionFocus:function(){return this.eachElement(function(d){d=
zjs(d);var g=d.getData("zmoduleautosuggestionwrapinputel");g?g.trigger("click"):d.focus()})},autosuggestionSetValue:function(d,g){d=d||"";return this.eachElement(function(a){var b=zjs(a).getData("zjsmoduleautosuggestionnewinput");if(b)try{b.value=d,zjs(a).getData("zjsmoduleautosuggestionkeytype")(g||!1)}catch(D){}else zjs(a).setValue(d)})},autosuggestionDisable:function(d){d=d||!1;return this.eachElement(function(g){var a=zjs(g).getData("zjsmoduleautosuggestionnewinput");g=zjs(g).getData("zmoduleautosuggestionwrapel");
if(a)try{(a.disabled=d)?g.addClass("disabled"):g.removeClass("disabled")}catch(b){}})}});zjs.hook({after_setInnerHTML:function(d){zjs(d).find(".zautosuggestion").makeAutosuggestion()},after_insertDOM:function(d){zjs(d).is(".zautosuggestion")&&zjs(d).makeAutosuggestion();zjs(d).find(".zautosuggestion").makeAutosuggestion()}});zjs(function(){zjs(".zautosuggestion").makeAutosuggestion()});"required"in zjs&&zjs.required("ui.autosuggestion")});