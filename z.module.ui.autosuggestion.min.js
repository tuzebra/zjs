zjs.require("dictionary, scrollbar",function(){zjs.extendCore({moduleUiAutosuggestionOption:{minlength:1,minheight:18,customcss:!0,focusshowsuggestion:!1,autofocus:!0,panelmaxheight:200,multiline:!0,multichoice:!1,mentionmode:!1,usedproperty:"text",searchproperty:"text",source:[],sourceUrl:"",initSourceUrl:"",sourceDataStructure:"",itemtemplate:'<div class="item">${text}</div>',itemhighlightclass:"highlight"}});var G=function(g,h){var b=zjs(g),a=b.getData("zjsmoduleautosuggestionoption"),B=!1;if(a)b.setData("zjsmoduleautosuggestionoption",
zjs.extend(a,h)),B=!0;else{var a=zjs.clone(zjs.moduleUiAutosuggestionOption),x=b.getAttr("data-option","");zjs.isString(x)&&""!=x.trim()&&(a=zjs.extend(a,x.jsonDecode()));b.removeAttr("data-option");"undefined"!=typeof h&&(a=zjs.extend(a,h));x=a.searchproperty;"id.text"==a.usedproperty&&(a.searchproperty="text",a.usedproperty="id",x="id.text");a.mentionmode&&(a.multichoice=!1);a.multichoice&&(a.multiline=!1);b.setData("zjsmoduleautosuggestionoption",a);var e=zjs('<div class="zui-autosuggestion-wrap"><div class="zui-autosuggestion-inputwrap"><div class="zui-autosuggestion-placeholder"></div><input class="zui-autosuggestion-input" autocomplete="off" /><textarea class="zui-autosuggestion-input" autocomplete="off"></textarea><div class="zui-autosuggestion-input-test-wrap"><div class="zui-autosuggestion-input-test"></div></div><div class="zui-estimate-height-wrap"><div class="zui-autosuggestion-input zui-estimate-height"></div></div></div><div class="zui-autosuggestion-panel-wrap zui-panel-hide"><div class="zui-autosuggestion-panel-scroll"><div class="zui-autosuggestion-panel-content"></div></div></div></div>');
a.multiline?e.find("input.zui-autosuggestion-input").remove():e.find("textarea.zui-autosuggestion-input").remove();b.setData("zmoduleautosuggestionwrapel",e);e.insertAfter(b);var r=e.find(".zui-autosuggestion-inputwrap"),k=e.find(".zui-autosuggestion-placeholder"),d=e.find("input.zui-autosuggestion-input,textarea.zui-autosuggestion-input"),l=e.find(".zui-autosuggestion-panel-wrap"),C=e.find(".zui-autosuggestion-panel-scroll"),q=e.find(".zui-autosuggestion-panel-content"),D=!1;b.setData("zmoduleautosuggestionwrapinputel",
r);b.setData("zjsmoduleautosuggestionnewinput",d.item(0,!0));a.multiline?(D=e.find(".zui-estimate-height"),e.addClass("multiline")):e.find(".zui-estimate-height-wrap").remove();b.on("focus",function(){d.focus()});d.on("focus",function(){e.addClass("focus")}).on("blur",function(){e.removeClass("focus")});a.autofocus&&d.focus();if(!a.customcss){var E=b.width(),H=b.height();b.getStyle("margin-left",!0);b.getStyle("margin-right",!0);b.getStyle("margin-top",!0);b.getStyle("margin-bottom",!0);var G=b.getStyle("padding-left",
!0),O=b.getStyle("padding-right",!0),P=b.getStyle("padding-top",!0),Q=b.getStyle("padding-bottom",!0),R=b.getStyle("border-left-width",!0),S=b.getStyle("border-right-width",!0),T=b.getStyle("border-top-width",!0),U=b.getStyle("border-bottom",!0),V=b.getStyle("font");"content-box"==b.getStyle("box-sizing")&&(E-=G+O+R+S,H-=P+Q+T+U);r.copyStyleFrom(b);r.setStyle({position:"relative",cursor:"text",width:E,height:H,"-webkit-text-fill-color":"initial"});d.setStyle({top:k.top(),font:V,width:E})}var F=!1;
a.multichoice?(e.addClass("zui-autosuggestion-multi-wrap"),F=e.find(".zui-autosuggestion-input-test").setStyle({margin:d.getStyle("margin"),padding:d.getStyle("padding"),font:d.getStyle("font"),border:d.getStyle("border")})):e.find(".zui-autosuggestion-input-test-wrap").remove();l.height(a.panelmaxheight);C.makeScrollbar({bounce:!1,usecss:!1,usekey:!1,customCssClass:"zui-autosuggestion-panel"});l.addClass("zui-panel-hide");var I=function(c){c=Math.min(c,a.panelmaxheight);l.height(c);C.scrollHeight(c).scrollToTop()},
y=b.getAttr("placeholder"),n=0,A=0,m="",p="",v=0,J="";k.setInnerHTML(y);b.setAttr({type:"hidden",autocomplete:"off"});""!=b.getValue("")&&(d.setValue(m=b.getValue()),k.setInnerHTML(""));var t=new zjs.dictionary(a.source,x);""!=a.sourceUrl&&t.setDataSourceUrl(a.sourceUrl);""!=a.initSourceUrl&&(t.setDataSourceUrl(a.initSourceUrl),t.useCacheDataSource(!0),t.getDataFromDataSource());""!=a.sourceDataStructure&&t.setDataSourceDataStructure(a.sourceDataStructure);b.setData("zjsmoduleautosuggestiondictionary",
t);var z=function(c,f){B&&(a=b.getData("zjsmoduleautosuggestionoption"),B=!1);var e=c.getKeyCode();38==e||40==e?"keydown"==f&&W(c,e):37!=e&&(39==e||9==e?("keydown"==f&&X(),9==e&&(l.addClass("zui-panel-hide"),b.trigger("ui:autosuggestion:blur"))):13==e?a.multichoice?""!=d.getValue("")&&("keydown"==f&&K(),c.preventDefault()):(e=l.hasClass("zui-panel-hide"),"keydown"==f&&K(),a.multiline&&(c.preventDefault(),u(),e&&function(){b.findUp("form").submit()}.delay(1))):27==e?(l.hasClass("zui-panel-hide")||
d.setValue(m),b.setValue("text"==a.usedproperty?m:""),k.setInnerHTML(p=""),l.addClass("zui-panel-hide"),q.find(".zui-autosuggestion-item").removeClass("highlight"),v=n=0,a.multiline&&u()):8==e?Y():L("keyup"==f||"input"==f))},W=function(c,f){c.preventDefault();q.find(".zui-autosuggestion-item").removeClass(a.itemhighlightclass);40==f&&n++;38==f&&n--;n>A&&(n=0);0>n&&(n=A);var e;if(0==n)e=m,k.setInnerHTML(p);else{var g=q.find('.zui-autosuggestion-item[data-highlight="'+n+'"]'),h=g.getData("searchtempdata");
g.addClass(a.itemhighlightclass);e=h.text;k.setInnerHTML("")}d.setValue(e);a.multichoice&&(d.width(F.setInnerHTML(d.getValue("")).width()+10),l.top(r.height()));h&&a.usedproperty in h&&b.setValue(h[a.usedproperty]);a.multiline&&u();C.scrollToElement(g);"object"==typeof h&&b.trigger("ui:autosuggestion:highlight",h)},X=function(){if(""!=p&&(d.setValue(m=p),k.setInnerHTML(p=""),0>=n&&(n=v),l.addClass("zui-panel-hide"),!(0>=n))){var c=q.find('.zui-autosuggestion-item[data-highlight="'+n+'"]').getData("searchtempdata");
"object"==typeof c&&(a.multichoice?(d.setValue("").width(10),c&&a.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",c[a.usedproperty]).insertBefore(d),e.addClass("zui-autosuggestion-with-token"),w())):(a.multiline&&u(),c&&a.usedproperty in c&&(J=c[a.usedproperty],m=c[a.searchproperty],b.setValue(J))),b.trigger("ui:autosuggestion:choice",c))}},K=function(){m=d.getValue("");var c={text:m};if((v||n||!l.hasClass("zui-panel-hide"))&&""!=m){var f=
!1;if(0<n)f=q.find('.zui-autosuggestion-item[data-highlight="'+n+'"]');else if(0<v)f=q.find('.zui-autosuggestion-item[data-highlight="'+v+'"]');else if("text"!=a.usedproperty){var g=q.find(".zui-autosuggestion-item");0<g.count()&&(f=g.item(0))}f&&(c=f.getData("searchtempdata"))}""!=m&&k.setInnerHTML(p="");l.addClass("zui-panel-hide");"object"==typeof c&&(a.multichoice?(d.setValue("").width(10),m="",c&&a.usedproperty in c&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(c.text).setAttr("data-value",
c[a.usedproperty]).insertBefore(d),e.addClass("zui-autosuggestion-with-token")),w()):c&&(k.setInnerHTML(p=""),l.addClass("zui-panel-hide"),a.searchproperty in c&&d.setValue(m=c[a.searchproperty]),a.usedproperty in c&&b.setValue(c[a.usedproperty])),b.trigger("ui:autosuggestion:choice",c))},Y=function(){a.multichoice&&""==d.getValue("")&&(e.find(".zui-autosuggestion-token").lastChild().remove(),w(),""==b.getValue()&&(e.removeClass("zui-autosuggestion-with-token"),p="",function(){k.top(d.top()).left(d.left()).show().setInnerHTML(y)}.delay(80)))},
L=function(c){var f=d.getValue("");m=f;if(a.multichoice){d.width(F.setInnerHTML(f).width()+10);if(""==f){""==b.getValue()?k.show().setInnerHTML(y):k.hide();p="";k.setInnerHTML(y);l.addClass("zui-panel-hide");return}k.top(d.top()).left(d.left()).show()}else if(a.multiline&&u(),b.setValue("text"==a.usedproperty?f:""),""==f||f.length<a.minlength){p="";""!=f?k.setInnerHTML(""):k.setInnerHTML(y);l.addClass("zui-panel-hide");return}c&&(n=0,p="",v=0,b.getData("zjsmoduleautosuggestiondictionary").asyncSearch(f,
function(c){if(0==c.length||""==d.getValue())k.setInnerHTML(""),l.addClass("zui-panel-hide");else{A=c.length;l.removeClass("zui-panel-hide").top(r.height());q.setInnerHTML("");var b=0;zjs.eachItem(c,function(c,d){var e=zjs('<div class="zui-autosuggestion-item"></div>').appendTo(q);e.setData("searchtempdata",c);e.setAttr("data-highlight",d+1);var g="";"function"==typeof a.itemtemplate&&(g=a.itemtemplate(c));"string"==typeof a.itemtemplate&&(g=a.itemtemplate);"string"==typeof g&&(g=g.format(c));zjs(g).appendTo(e);
b+=e.height();e.hover(M);e.click(N);""==p&&0==c.text.indexOf(f)&&(p=c.text,v=d+1)});k.setInnerHTML(p);I(b)}}))};b.setData("zjsmoduleautosuggestionkeytype",L);var M=function(c){q.find(".zui-autosuggestion-item").removeClass(a.itemhighlightclass);c=zjs(this).addClass(a.itemhighlightclass).getData("searchtempdata");"object"==typeof c&&b.trigger("ui:autosuggestion:highlight",c)},N=function(c){c=zjs(this);var f=c.getData("searchtempdata");"object"==typeof f&&(m=f.text,d.setValue(m),a.multichoice?(d.setValue("").width(10),
f&&a.usedproperty in f&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(f.text).setAttr("data-value",f[a.usedproperty]).insertBefore(d),e.addClass("zui-autosuggestion-with-token"),w())):(f&&a.usedproperty in f&&b.setValue(f[a.usedproperty]),a.multiline&&u()),n=c.getAttr("data-highlight",0).toInt(),k.setInnerHTML(p=""),l.addClass("zui-panel-hide"),d.focus(),b.trigger("ui:autosuggestion:choice",f))},w=function(){var a=[];e.find(".zui-autosuggestion-token").eachElement(function(c){a.push(zjs(c).getAttr("data-value",
""))});b.setValue(a.join(","))},u=function(){D.setInnerHTML(d.getValue());var c=Math.max(D.height(),a.minheight);d.height(c);l.hasClass("zui-panel-hide")||l.top(r.height())};a.multiline&&(zjs(window).on("resize",u),u.delay(1));if("oninput"in document.createElement("input"))d.on("keydown",function(a,b){z(a,"keydown")}).on("input",function(a,b){z(a,"input")});else d.on("keydown",function(a,b){z(a,"keydown")}).on("keypress",function(a,b){z(a,"keypress")}).on("keyup",function(a,b){z(a,"keyup")}).on("mouseup",
function(a,b){z(a,"keyup")});d.on("blur",function(a){b.trigger("ui:autosuggestion:blur")});r.on("click",function(){d.focus()});if(a.focusshowsuggestion)r.on("click",function(c){""==m&&(c=c.getTarget(),zjs(c).hasClass("zui-autosuggestion-token")||function(){var c=b.getData("zjsmoduleautosuggestiondictionary").search("");if(0!=c.length){A=c.length;l.removeClass("zui-panel-hide").top(r.height());q.setInnerHTML("");var e=0;zjs.eachItem(c,function(b,c){var d=zjs('<div class="zui-autosuggestion-item"></div>').appendTo(q);
d.setData("searchtempdata",b);d.setAttr("data-highlight",c+1);var f="";"function"==typeof a.itemtemplate&&(f=a.itemtemplate(b));"string"==typeof a.itemtemplate&&(f=a.itemtemplate);"string"==typeof f&&(f=f.format(b));zjs(f).appendTo(d);e+=d.height();d.hover(M);d.click(N)});I(e)}}.delay(100))});zjs(document).on("click",function(a){l.addClass("zui-panel-hide")});if(a.multichoice)r.on("click",".zui-autosuggestion-token",function(a){this.remove();w();""==b.getValue()&&(e.removeClass("zui-autosuggestion-with-token"),
""==m&&(p="",k.setInnerHTML(y)));(function(){k.show().top(d.top()).left(d.left())}).delay(50)});!a.multichoice||""==m||"id"!=a.usedproperty&&"text"!=a.usedproperty||("id"==a.usedproperty?zjs.eachItem(m.split(/\s*,\s*/),function(b){t.asyncGetItemById(b,function(b){b&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(b.text).setAttr("data-value",b[a.usedproperty]).insertBefore(d),w())})}):"text"==a.usedproperty&&zjs.eachItem(m.split(/\s*,\s*/),function(b){t.asyncSearch(b,function(b){0>=
b.length||(b=b[0],zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(b.text).setAttr("data-value",b[a.usedproperty]).insertBefore(d),w())})}),e.addClass("zui-autosuggestion-with-token"),d.setValue(m=""),k.hide())}};zjs.extendMethod({makeAutosuggestion:function(g){return this.eachElement(function(h){G(h,g)})},autosuggestionAddindex:function(g){return this.eachElement(function(h){var b=zjs(h);h=b.getData("zjsmoduleautosuggestiondictionary");b=b.getData("zjsmoduleautosuggestionoption");
h&&h.addIndex(g,b.searchproperty)})},autosuggestionRemoveindex:function(g,h){return this.eachElement(function(b){(b=zjs(b).getData("zjsmoduleautosuggestiondictionary"))&&b.removeIndex(g,h)})},autosuggestionFocus:function(){return this.eachElement(function(g){(g=zjs(g).getData("zmoduleautosuggestionwrapinputel"))&&g.trigger("click")})},autosuggestionSetValue:function(g){"undefined"==typeof g&&(g="");return this.eachElement(function(h){var b=zjs(h).getData("zjsmoduleautosuggestionnewinput");if(b)try{b.value=
g,zjs(h).getData("zjsmoduleautosuggestionkeytype")(!0)}catch(a){}})},autosuggestionDisable:function(g){g=g||!1;return this.eachElement(function(h){var b=zjs(h).getData("zjsmoduleautosuggestionnewinput");h=zjs(h).getData("zmoduleautosuggestionwrapel");if(b)try{(b.disabled=g)?h.addClass("disabled"):h.removeClass("disabled")}catch(a){}})}});zjs.hook({after_setInnerHTML:function(g){zjs(g).find(".zautosuggestion").makeAutosuggestion()},after_insertDOM:function(g){zjs(g).is(".zautosuggestion")&&zjs(g).makeAutosuggestion();
zjs(g).find(".zautosuggestion").makeAutosuggestion()}});zjs(function(){zjs(".zautosuggestion").makeAutosuggestion()});"required"in zjs&&zjs.required("ui.autosuggestion")});