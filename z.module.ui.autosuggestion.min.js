zjs.require("dictionary, scrollbar",function(){zjs.extendCore({moduleUiAutosuggestionOption:{minlength:1,minheight:18,customcss:!0,focusshowsuggestion:!1,autofocus:!1,panelmaxheight:200,multiline:!0,multichoice:!1,mentionmode:!1,usedproperty:"text",searchproperty:"text",noneValue:"",source:[],sourceUrl:"",initSourceUrl:"",sourceDataStructure:"",itemtemplate:'<div class="item">${text}</div>',itemLinkFormat:"",itemhighlightclass:"highlight"}});var I=function(g,c){var a=zjs(g),b=a.getData("zjsmoduleautosuggestionoption"),
D=!1;if(b)a.setData("zjsmoduleautosuggestionoption",zjs.extend(b,c)),D=!0;else{var b=zjs.clone(zjs.moduleUiAutosuggestionOption),v=a.getAttr("data-option","");zjs.isString(v)&&""!=v.trim()&&(b=zjs.extend(b,v.jsonDecode()));a.removeAttr("data-option");b.sourceUrl||(v=a.getAttr("data-autocomplete-path",""),""!==v&&(b.sourceUrl=v));"undefined"!=typeof c&&(b=zjs.extend(b,c));var r=!1;zjs.isString(b.source)&&(r=zjs(b.source),0<r.count()?(b.multichoice=!1,b.usedproperty="id.text",b.source={},r.find("option").eachElement(function(e,
f){var d=zjs(e).getValue(),c=zjs(e).getInnerText();d!==b.noneValue&&(b.source[d]=c,0===f&&d!=b.noneValue&&a.setValue(d),e.selected&&d!=b.noneValue&&a.setValue(c))}),r.hide()):r=!1);v=b.searchproperty;"id.text"==b.usedproperty&&(b.searchproperty="text",b.usedproperty="id",v="id.text");b.mentionmode&&(b.multichoice=!1);b.multichoice&&(b.multiline=!1);a.setData("zjsmoduleautosuggestionoption",b);var h=zjs('<div class="zui-autosuggestion-wrap"><div class="zui-autosuggestion-inputwrap"><div class="zui-autosuggestion-placeholder"></div><input class="zui-autosuggestion-input" autocomplete="off" /><textarea class="zui-autosuggestion-input" autocomplete="off"></textarea><div class="zui-autosuggestion-input-test-wrap"><div class="zui-autosuggestion-input-test"></div></div><div class="zui-estimate-height-wrap"><div class="zui-autosuggestion-input zui-estimate-height"></div></div></div><div class="zui-autosuggestion-panel-wrap zui-panel-hide"><div class="zui-autosuggestion-panel-scroll"><div class="zui-autosuggestion-panel-content"></div></div></div></div>');
b.multiline?h.find("input.zui-autosuggestion-input").remove():h.find("textarea.zui-autosuggestion-input").remove();a.setData("zmoduleautosuggestionwrapel",h);h.insertAfter(a);var u=h.find(".zui-autosuggestion-inputwrap"),k=h.find(".zui-autosuggestion-placeholder"),d=h.find("input.zui-autosuggestion-input,textarea.zui-autosuggestion-input"),m=h.find(".zui-autosuggestion-panel-wrap"),E=h.find(".zui-autosuggestion-panel-scroll"),t=h.find(".zui-autosuggestion-panel-content"),F=!1;a.setData("zmoduleautosuggestionwrapinputel",
u);a.setData("zjsmoduleautosuggestionnewinput",d.item(0,!0));b.multiline?(F=h.find(".zui-estimate-height"),h.addClass("multiline")):h.find(".zui-estimate-height-wrap").remove();a.on("focus",function(){d.focus()});d.on("focus",function(){h.addClass("focus")}).on("blur",function(){h.removeClass("focus");r&&""===d.getValue().trim()&&r.setValue(b.noneValue)});b.autofocus&&d.focus();if(!b.customcss){var G=a.width(),J=a.height();a.getStyle("margin-left",!0);a.getStyle("margin-right",!0);a.getStyle("margin-top",
!0);a.getStyle("margin-bottom",!0);var I=a.getStyle("padding-left",!0),S=a.getStyle("padding-right",!0),T=a.getStyle("padding-top",!0),U=a.getStyle("padding-bottom",!0),V=a.getStyle("border-left-width",!0),W=a.getStyle("border-right-width",!0),X=a.getStyle("border-top-width",!0),Y=a.getStyle("border-bottom",!0),Z=a.getStyle("font");"content-box"==a.getStyle("box-sizing")&&(G-=I+S+V+W,J-=T+U+X+Y);u.copyStyleFrom(a);u.setStyle({position:"relative",cursor:"text",width:G,height:J,"-webkit-text-fill-color":"initial"});
d.setStyle({top:k.top(),font:Z,width:G})}var H=!1;b.multichoice?(h.addClass("zui-autosuggestion-multi-wrap"),H=h.find(".zui-autosuggestion-input-test").setStyle({margin:d.getStyle("margin"),padding:d.getStyle("padding"),font:d.getStyle("font"),border:d.getStyle("border")})):h.find(".zui-autosuggestion-input-test-wrap").remove();m.height(b.panelmaxheight);E.makeScrollbar({bounce:!1,usecss:!1,usekey:!1,customCssClass:"zui-autosuggestion-panel"});m.addClass("zui-panel-hide");var K=function(a){a=Math.min(a,
b.panelmaxheight);m.height(a);E.scrollHeight(a).scrollToTop()},L="",A=a.getAttr("placeholder"),p=0,C=0,n="",q="",y=0,M="";l(k,A);a.setAttr({type:"hidden",autocomplete:"off"});""!=a.getValue("")&&(d.setValue(n=a.getValue()),l(k,""));var w=new zjs.dictionary(b.source,v);""!=b.sourceUrl&&w.setDataSourceUrl(b.sourceUrl);""!=b.initSourceUrl&&(w.setDataSourceUrl(b.initSourceUrl),w.useCacheDataSource(!0),w.getDataFromDataSource());""!=b.sourceDataStructure&&w.setDataSourceDataStructure(b.sourceDataStructure);
a.setData("zjsmoduleautosuggestiondictionary",w);var B=function(e,f){D&&(b=a.getData("zjsmoduleautosuggestionoption"),D=!1);var c=e.getKeyCode();38==c||40==c?"keydown"==f&&aa(e,c):37!=c&&(39==c||9==c?("keydown"==f&&ba(),9==c&&(m.addClass("zui-panel-hide"),a.trigger("ui:autosuggestion:blur"))):13==c?b.multichoice?""!=d.getValue("")&&("keydown"==f&&N(),e.preventDefault()):(c=m.hasClass("zui-panel-hide"),"keydown"==f&&N(),b.multiline&&(e.preventDefault(),x(),c&&function(){a.findUp("form").submit()}.delay(1))):
27==c?(m.hasClass("zui-panel-hide")||d.setValue(n),a.setValue("text"==b.usedproperty?n:""),l(k,q=""),m.addClass("zui-panel-hide"),t.find(".zui-autosuggestion-item").removeClass("highlight"),y=p=0,b.multiline&&x()):8==c?ca():O("keyup"==f||"input"==f))},aa=function(e,f){e.preventDefault();t.find(".zui-autosuggestion-item").removeClass(b.itemhighlightclass);40==f&&p++;38==f&&p--;p>C&&(p=0);0>p&&(p=C);if(0==p){var c=n;l(k,q)}else{var g=t.find('.zui-autosuggestion-item[data-highlight="'+p+'"]');var h=
g.getData("searchtempdata");g.addClass(b.itemhighlightclass);c=h.text;l(k,"")}d.setValue(c);b.multichoice&&(d.width(H.setInnerHTML(d.getValue("")).width()+10),m.top(u.height()));h&&b.usedproperty in h&&a.setValue(h[b.usedproperty]);b.multiline&&x();E.scrollToElement(g);"object"==typeof h&&(a.trigger("ui:autosuggestion:highlight",h),""!=b.itemLinkFormat&&(L=g.getAttr("href")))},ba=function(){if(""!=q&&(d.setValue(n=q),l(k,q=""),0>=p&&(p=y),m.addClass("zui-panel-hide"),!(0>=p))){var e=t.find('.zui-autosuggestion-item[data-highlight="'+
p+'"]').getData("searchtempdata");"object"==typeof e&&(b.multichoice?(d.setValue("").width(10),e&&b.usedproperty in e&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(e.text).setAttr("data-value",e[b.usedproperty]).insertBefore(d),h.addClass("zui-autosuggestion-with-token"),z())):(b.multiline&&x(),e&&b.usedproperty in e&&(M=e[b.usedproperty],n=e[b.searchproperty],a.setValue(M))),r&&r.setValue(e.id),a.trigger("ui:autosuggestion:choice",e))}},N=function(){n=d.getValue("");var e={text:n},
f=!1;if((y||p||!m.hasClass("zui-panel-hide"))&&""!=n){if(0<p)f=t.find('.zui-autosuggestion-item[data-highlight="'+p+'"]');else if(0<y)f=t.find('.zui-autosuggestion-item[data-highlight="'+y+'"]');else if("text"!=b.usedproperty){var c=t.find(".zui-autosuggestion-item");0<c.count()&&(f=c.item(0))}f&&(e=f.getData("searchtempdata"))}""!=n&&l(k,q="");m.addClass("zui-panel-hide");"object"==typeof e&&(b.multichoice?(d.setValue("").width(10),n="",e&&b.usedproperty in e&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(e.text).setAttr("data-value",
e[b.usedproperty]).insertBefore(d),h.addClass("zui-autosuggestion-with-token")),z()):e&&(l(k,q=""),m.addClass("zui-panel-hide"),b.searchproperty in e&&d.setValue(n=e[b.searchproperty]),b.usedproperty in e&&a.setValue(e[b.usedproperty])),r&&r.setValue(e.id),a.trigger("ui:autosuggestion:choice",e),""!=b.itemLinkFormat&&f&&(e=f.getAttr("href"),e==L&&(window.location.href=e)))},ca=function(){b.multichoice&&""==d.getValue("")&&(h.find(".zui-autosuggestion-token").lastChild().remove(),z(),""==a.getValue()&&
(h.removeClass("zui-autosuggestion-with-token"),q="",function(){k.top(d.top()).left(d.left()).show();l(k,A)}.delay(80)))},O=function(e){var f=d.getValue("");n=f;if(b.multichoice){d.width(H.setInnerHTML(f).width()+10);if(""==f){""==a.getValue()?l(k.show(),A):k.hide();q="";l(k,A);m.addClass("zui-panel-hide");return}k.top(d.top()).left(d.left()).show()}else if(b.multiline&&x(),a.setValue("text"==b.usedproperty?f:""),""==f||f.length<b.minlength){q="";""!=f?l(k,""):l(k,A,f);m.addClass("zui-panel-hide");
return}e&&(p=0,q="",y=0,a.getData("zjsmoduleautosuggestiondictionary").asyncSearch(f,function(a){if(0==a.length||""==d.getValue())l(k,""),m.addClass("zui-panel-hide");else{C=a.length;m.removeClass("zui-panel-hide").top(u.height());t.setInnerHTML("");var e=0;zjs.eachItem(a,function(a,c){var d=P(b,t,a,c);e+=d.height();d.hover(Q);d.click(R);""==q&&0==a.text.indexOf(f)&&(q=a.text,y=c+1)});l(k,q,f);K(e)}}))};a.setData("zjsmoduleautosuggestionkeytype",O);var Q=function(e){t.find(".zui-autosuggestion-item").removeClass(b.itemhighlightclass);
e=zjs(this).addClass(b.itemhighlightclass).getData("searchtempdata");"object"==typeof e&&a.trigger("ui:autosuggestion:highlight",e)},R=function(e){e=zjs(this);var f=e.getData("searchtempdata");"object"==typeof f&&(n=f.text,d.setValue(n),b.multichoice?(d.setValue("").width(10),f&&b.usedproperty in f&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(f.text).setAttr("data-value",f[b.usedproperty]).insertBefore(d),h.addClass("zui-autosuggestion-with-token"),z())):(f&&b.usedproperty in
f&&a.setValue(f[b.usedproperty]),b.multiline&&x()),r&&r.setValue(f.id),p=e.getAttr("data-highlight",0).toInt(),l(k,q=""),m.addClass("zui-panel-hide"),d.focus(),a.trigger("ui:autosuggestion:choice",f))},z=function(){var b=[];h.find(".zui-autosuggestion-token").eachElement(function(a){b.push(zjs(a).getAttr("data-value",""))});a.setValue(b.join(","))},x=function(){F.setInnerHTML(d.getValue());var a=Math.max(F.height(),b.minheight);d.height(a);m.hasClass("zui-panel-hide")||m.top(u.height())};b.multiline&&
(zjs(window).on("resize",x),x.delay(1));if("oninput"in document.createElement("input"))d.on("keydown",function(b,a){B(b,"keydown")}).on("input",function(b,a){B(b,"input")});else d.on("keydown",function(b,a){B(b,"keydown")}).on("keypress",function(b,a){B(b,"keypress")}).on("keyup",function(b,a){B(b,"keyup")}).on("mouseup",function(b,a){B(b,"keyup")});d.on("blur",function(b){a.trigger("ui:autosuggestion:blur")});u.on("click",function(){d.focus()});if(b.focusshowsuggestion)u.on("click",function(c){""==
n&&(c=c.getTarget(),zjs(c).hasClass("zui-autosuggestion-token")||function(){var c=a.getData("zjsmoduleautosuggestiondictionary").search("");if(0!=c.length){C=c.length;m.removeClass("zui-panel-hide").top(u.height());t.setInnerHTML("");var e=0;zjs.eachItem(c,function(a,c){var d=P(b,t,a,c);e+=d.height();d.hover(Q);d.click(R)});K(e)}}.delay(100))});zjs(document).on("click",function(b){m.addClass("zui-panel-hide")});if(b.multichoice)u.on("click",".zui-autosuggestion-token",function(b){this.remove();z();
""==a.getValue()&&(h.removeClass("zui-autosuggestion-with-token"),""==n&&(q="",l(k,A)));(function(){k.show().top(d.top()).left(d.left())}).delay(50)});!b.multichoice||""==n||"id"!=b.usedproperty&&"text"!=b.usedproperty||("id"==b.usedproperty?zjs.eachItem(n.split(/\s*,\s*/),function(a){w.asyncGetItemById(a,function(a){a&&(zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(a.text).setAttr("data-value",a[b.usedproperty]).insertBefore(d),z())})}):"text"==b.usedproperty&&zjs.eachItem(n.split(/\s*,\s*/),
function(a){w.asyncSearch(a,function(a){0>=a.length||(a=a[0],zjs('<div class="zui-autosuggestion-token"></div>').setInnerHTML(a.text).setAttr("data-value",a[b.usedproperty]).insertBefore(d),z())})}),h.addClass("zui-autosuggestion-with-token"),d.setValue(n=""),k.hide())}},P=function(g,c,a,b){var l=""!=g.itemLinkFormat?zjs('<a class="zui-autosuggestion-item"></a>').setAttr("href",g.itemLinkFormat.format(a)):zjs('<div class="zui-autosuggestion-item"></div>');l.appendTo(c);l.setData("searchtempdata",
a);l.setAttr("data-highlight",b+1);c="";"function"==typeof g.itemtemplate&&(c=g.itemtemplate(a));"string"==typeof g.itemtemplate&&(c=g.itemtemplate);"string"==typeof c&&(c=c.format(a));zjs(c).appendTo(l);return l},l=function(g,c,a){c=c||"";(a=a||"")&&c&&(c=c.replace(a,'<span class="_hide">'+a+"</span>"));g.setInnerHTML(c)};zjs.extendMethod({makeAutosuggestion:function(g){return this.eachElement(function(c){I(c,g)})},autosuggestionAddindex:function(g){return this.eachElement(function(c){var a=zjs(c);
c=a.getData("zjsmoduleautosuggestiondictionary");a=a.getData("zjsmoduleautosuggestionoption");c&&c.addIndex(g,a.searchproperty)})},autosuggestionRemoveindex:function(g,c){return this.eachElement(function(a){(a=zjs(a).getData("zjsmoduleautosuggestiondictionary"))&&a.removeIndex(g,c)})},autosuggestionFocus:function(){return this.eachElement(function(g){(g=zjs(g).getData("zmoduleautosuggestionwrapinputel"))&&g.trigger("click")})},autosuggestionSetValue:function(g){"undefined"==typeof g&&(g="");return this.eachElement(function(c){var a=
zjs(c).getData("zjsmoduleautosuggestionnewinput");if(a)try{a.value=g,zjs(c).getData("zjsmoduleautosuggestionkeytype")(!0)}catch(b){}})},autosuggestionDisable:function(g){g=g||!1;return this.eachElement(function(c){var a=zjs(c).getData("zjsmoduleautosuggestionnewinput");c=zjs(c).getData("zmoduleautosuggestionwrapel");if(a)try{(a.disabled=g)?c.addClass("disabled"):c.removeClass("disabled")}catch(b){}})}});zjs.hook({after_setInnerHTML:function(g){zjs(g).find(".zautosuggestion").makeAutosuggestion()},
after_insertDOM:function(g){zjs(g).is(".zautosuggestion")&&zjs(g).makeAutosuggestion();zjs(g).find(".zautosuggestion").makeAutosuggestion()}});zjs(function(){zjs(".zautosuggestion").makeAutosuggestion()});"required"in zjs&&zjs.required("ui.autosuggestion")});