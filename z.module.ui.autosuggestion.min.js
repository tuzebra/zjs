zjs.require("dictionary, scrollbar",function(){zjs.extendCore({moduleUiAutosuggestionOption:{minlength:1,minheight:18,customcss:!0,focusshowsuggestion:!1,autofocus:!0,panelmaxheight:200,multiline:!0,multichoice:!1,mentionmode:!1,usedproperty:"text",searchproperty:"text",source:[],sourceUrl:"",initSourceUrl:"",sourceDataStructure:"",itemtemplate:'<div class="item">${text}</div>',itemhighlightclass:"highlight"}});var H=function(d,h){var a=zjs(d),b=a.getData("zjsmoduleautosuggestionoption"),C=!1;if(b)a.setData("zjsmoduleautosuggestionoption",
zjs.extend(b,h)),C=!0;else{var b=zjs.clone(zjs.moduleUiAutosuggestionOption),y=a.getAttr("data-option","");zjs.isString(y)&&""!=y.trim()&&(b=zjs.extend(b,y.jsonDecode()));a.removeAttr("data-option");"undefined"!=typeof h&&(b=zjs.extend(b,h));y=b.searchproperty;"id.text"==b.usedproperty&&(b.searchproperty="text",b.usedproperty="id",y="id.text");b.mentionmode&&(b.multichoice=!1);b.multichoice&&(b.multiline=!1);a.setData("zjsmoduleautosuggestionoption",b);var f=zjs('<div class="zui-autosuggestion-wrap"><div class="zui-autosuggestion-inputwrap"><div class="zui-autosuggestion-placeholder"></div><input class="zui-autosuggestion-input" autocomplete="off" /><textarea class="zui-autosuggestion-input" autocomplete="off"></textarea><div class="zui-autosuggestion-input-test-wrap"><div class="zui-autosuggestion-input-test"></div></div><div class="zui-estimate-height-wrap"><div class="zui-autosuggestion-input zui-estimate-height"></div></div></div><div class="zui-autosuggestion-panel-wrap zui-panel-hide"><div class="zui-autosuggestion-panel-scroll"><div class="zui-autosuggestion-panel-content"></div></div></div></div>');
b.multiline?f.find("input.zui-autosuggestion-input").remove():f.find("textarea.zui-autosuggestion-input").remove();a.setData("zmoduleautosuggestionwrapel",f);f.insertAfter(a);var t=f.find(".zui-autosuggestion-inputwrap"),l=f.find(".zui-autosuggestion-placeholder"),c=f.find("input.zui-autosuggestion-input,textarea.zui-autosuggestion-input"),m=f.find(".zui-autosuggestion-panel-wrap"),D=f.find(".zui-autosuggestion-panel-scroll"),r=f.find(".zui-autosuggestion-panel-content"),E=!1;a.setData("zmoduleautosuggestionwrapinputel",
t);a.setData("zjsmoduleautosuggestionnewinput",c.item(0,!0));b.multiline?(E=f.find(".zui-estimate-height"),f.addClass("multiline")):f.find(".zui-estimate-height-wrap").remove();a.on("focus",function(){c.focus()});c.on("focus",function(){f.addClass("focus")}).on("blur",function(){f.removeClass("focus")});b.autofocus&&c.focus();if(!b.customcss){var F=a.width(),I=a.height();a.getStyle("margin-left",!0);a.getStyle("margin-right",!0);a.getStyle("margin-top",!0);a.getStyle("margin-bottom",!0);var H=a.getStyle("padding-left",
!0),O=a.getStyle("padding-right",!0),P=a.getStyle("padding-top",!0),Q=a.getStyle("padding-bottom",!0),R=a.getStyle("border-left-width",!0),S=a.getStyle("border-right-width",!0),T=a.getStyle("border-top-width",!0),U=a.getStyle("border-bottom",!0),V=a.getStyle("font");"content-box"==a.getStyle("box-sizing")&&(F-=H+O+R+S,I-=P+Q+T+U);t.copyStyleFrom(a);t.setStyle({position:"relative",cursor:"text",width:F,height:I,"-webkit-text-fill-color":"initial"});c.setStyle({top:l.top(),font:V,width:F})}var G=!1;
b.multichoice?(f.addClass("zui-autosuggestion-multi-wrap"),G=f.find(".zui-autosuggestion-input-test").setStyle({margin:c.getStyle("margin"),padding:c.getStyle("padding"),font:c.getStyle("font"),border:c.getStyle("border")})):f.find(".zui-autosuggestion-input-test-wrap").remove();m.height(b.panelmaxheight);D.makeScrollbar({bounce:!1,usekey:!1,customCssClass:"zui-autosuggestion-panel"});m.addClass("zui-panel-hide");var J=function(a){a=Math.min(a,b.panelmaxheight);m.height(a);D.scrollHeight(a).scrollToTop()},
z=a.getAttr("placeholder"),n=0,B=0,k="",p="",w=0;l.html(z);a.setAttr({type:"hidden",autocomplete:"off"});""!=a.getValue("")&&(c.setValue(k=a.getValue()),l.html(""));var u=new zjs.dictionary(b.source,y);""!=b.sourceUrl&&u.setDataSourceUrl(b.sourceUrl);""!=b.initSourceUrl&&(u.setDataSourceUrl(b.initSourceUrl),u.useCacheDataSource(!0),u.getDataFromDataSource());""!=b.sourceDataStructure&&u.setDataSourceDataStructure(b.sourceDataStructure);a.setData("zjsmoduleautosuggestiondictionary",u);var A=function(e,
g){C&&(b=a.getData("zjsmoduleautosuggestionoption"),C=!1);var q=e.keyCode();38==q||40==q?"keydown"==g&&W(e,q):37!=q&&(39==q||9==q?("keydown"==g&&X(),9==q&&(m.addClass("zui-panel-hide"),a.trigger("ui.autosuggestion.blur"))):13==q?b.multichoice?""!=c.getValue("")&&("keydown"==g&&K(),e.preventDefault()):(q=m.hasClass("zui-panel-hide"),"keydown"==g&&K(),b.multiline&&(e.preventDefault(),v(),q&&function(){a.findUp("form").submit()}.delay(1))):27==q?(m.hasClass("zui-panel-hide")||c.setValue(k),a.setValue("text"==
b.usedproperty?k:""),l.html(p=""),m.addClass("zui-panel-hide"),r.find(".zui-autosuggestion-item").removeClass("highlight"),w=n=0,b.multiline&&v()):8==q?Y():L("keyup"==g||"input"==g))},W=function(e,g){e.preventDefault();r.find(".zui-autosuggestion-item").removeClass(b.itemhighlightclass);40==g&&n++;38==g&&n--;n>B&&(n=0);0>n&&(n=B);var q;if(0==n)q=k,l.html(p);else{var f=r.find(".zui-autosuggestion-item[data-highlight="+n+"]"),d=f.getData("searchtempdata");f.addClass(b.itemhighlightclass);q=d.text;l.html("")}c.setValue(q);
b.multichoice&&(c.width(G.html(c.getValue("")).width()+10),m.top(t.height()));d&&b.usedproperty in d&&a.setValue(d[b.usedproperty]);b.multiline&&v();D.scrollToElement(f);"object"==typeof d&&a.trigger("ui.autosuggestion.highlight",d)},X=function(){if(""!=p&&(c.setValue(k=p),l.html(p=""),0>=n&&(n=w),m.addClass("zui-panel-hide"),!(0>=n))){var e=r.find(".zui-autosuggestion-item[data-highlight="+n+"]").getData("searchtempdata");"object"==typeof e&&(b.multichoice?(c.setValue("").width(10),e&&b.usedproperty in
e&&(zjs('<div class="zui-autosuggestion-token"></div>').html(e.text).setAttr("data-value",e[b.usedproperty]).insertBefore(c),f.addClass("zui-autosuggestion-with-token"),x())):(b.multiline&&v(),e&&b.usedproperty in e&&(k=e[b.usedproperty],a.setValue(k),c.setValue(k))),a.trigger("ui.autosuggestion.choice",e))}},K=function(){k=c.getValue("");var e={text:k};if((w||n||!m.hasClass("zui-panel-hide"))&&""!=k){var g=!1;if(0<n)g=r.find(".zui-autosuggestion-item[data-highlight="+n+"]");else if(0<w)g=r.find(".zui-autosuggestion-item[data-highlight="+
w+"]");else if("text"!=b.usedproperty){var d=r.find(".zui-autosuggestion-item");0<d.count()&&(g=d.item(0))}g&&(e=g.getData("searchtempdata"))}""!=k&&l.html(p="");m.addClass("zui-panel-hide");"object"==typeof e&&(b.multichoice?(c.setValue("").width(10),k="",e&&b.usedproperty in e&&(zjs('<div class="zui-autosuggestion-token"></div>').html(e.text).setAttr("data-value",e[b.usedproperty]).insertBefore(c),f.addClass("zui-autosuggestion-with-token")),x()):e&&(c.setValue(k=e.text),l.html(p=""),m.addClass("zui-panel-hide"),
b.usedproperty in e&&a.setValue(e[b.usedproperty])),a.trigger("ui.autosuggestion.choice",e))},Y=function(){b.multichoice&&""==c.getValue("")&&(f.find(".zui-autosuggestion-token").lastChild().remove(),x(),""==a.getValue()&&(f.removeClass("zui-autosuggestion-with-token"),p="",function(){l.top(c.top()).left(c.left()).show().html(z)}.delay(80)))},L=function(e){var g=c.getValue("");k=g;if(b.multichoice){c.width(G.html(g).width()+10);if(""==g){""==a.getValue()?l.show().html(z):l.hide();p="";l.html(z);m.addClass("zui-panel-hide");
return}l.top(c.top()).left(c.left()).show()}else if(b.multiline&&v(),a.setValue("text"==b.usedproperty?g:""),""==g||g.length<b.minlength){p="";""!=g?l.html(""):l.html(z);m.addClass("zui-panel-hide");return}e&&(n=0,p="",w=0,a.getData("zjsmoduleautosuggestiondictionary").asyncSearch(g,function(a){if(0==a.length||""==c.getValue())l.html(""),m.addClass("zui-panel-hide");else{B=a.length;m.removeClass("zui-panel-hide").top(t.height());r.html("");var e=0;a.each(function(a,c){var d=zjs('<div class="zui-autosuggestion-item"></div>').appendTo(r);
d.setData("searchtempdata",a);d.setAttr("data-highlight",c+1);var f="";"function"==typeof b.itemtemplate&&(f=b.itemtemplate(a));"string"==typeof b.itemtemplate&&(f=b.itemtemplate);"string"==typeof f&&(f=f.format(a));zjs(f).appendTo(d);e+=d.height();d.hover(M);d.click(N);""==p&&0==a.text.indexOf(g)&&(p=a.text,w=c+1)});l.html(p);J(e)}}))};a.setData("zjsmoduleautosuggestionkeytype",L);var M=function(e,g){r.find(".zui-autosuggestion-item").removeClass(b.itemhighlightclass);var c=zjs(g).addClass(b.itemhighlightclass).getData("searchtempdata");
"object"==typeof c&&a.trigger("ui.autosuggestion.highlight",c)},N=function(e,g){var d=zjs(g),h=d.getData("searchtempdata");"object"==typeof h&&(k=h.text,c.setValue(k),b.multichoice?(c.setValue("").width(10),h&&b.usedproperty in h&&(zjs('<div class="zui-autosuggestion-token"></div>').html(h.text).setAttr("data-value",h[b.usedproperty]).insertBefore(c),f.addClass("zui-autosuggestion-with-token"),x())):(h&&b.usedproperty in h&&a.setValue(h[b.usedproperty]),b.multiline&&v()),n=d.getAttr("data-highlight",
0).toInt(),l.html(p=""),m.addClass("zui-panel-hide"),c.focus(),a.trigger("ui.autosuggestion.choice",h))},x=function(){var b=[];f.find(".zui-autosuggestion-token").each(function(a){b.push(zjs(a).getAttr("data-value",""))});a.setValue(b.join(","))},v=function(){E.html(c.getValue());var a=Math.max(E.height(),b.minheight);c.height(a);m.hasClass("zui-panel-hide")||m.top(t.height())};b.multiline&&(zjs(window).on("resize",v),v.delay(1));if("oninput"in document.createElement("input"))c.on("keydown",function(b,
a){A(b,"keydown")}).on("input",function(b,a){A(b,"input")});else c.on("keydown",function(b,a){A(b,"keydown")}).on("keypress",function(b,a){A(b,"keypress")}).on("keyup",function(b,a){A(b,"keyup")}).on("mouseup",function(b,a){A(b,"keyup")});c.on("blur",function(b){a.trigger("ui.autosuggestion.blur")});t.on("click",function(){c.focus()});if(b.focusshowsuggestion)t.on("click",function(c){""==k&&(c=c.target(),zjs(c).hasClass("zui-autosuggestion-token")||function(){var c=a.getData("zjsmoduleautosuggestiondictionary").search("");
if(0!=c.length){B=c.length;m.removeClass("zui-panel-hide").top(t.height());r.html("");var d=0;c.each(function(a,c){var e=zjs('<div class="zui-autosuggestion-item"></div>').appendTo(r);e.setData("searchtempdata",a);e.setAttr("data-highlight",c+1);var g="";"function"==typeof b.itemtemplate&&(g=b.itemtemplate(a));"string"==typeof b.itemtemplate&&(g=b.itemtemplate);"string"==typeof g&&(g=g.format(a));zjs(g).appendTo(e);d+=e.height();e.hover(M);e.click(N)});J(d)}}.delay(100))});zjs(document).click(function(b){m.addClass("zui-panel-hide")});
if(b.multichoice)t.on("click",".zui-autosuggestion-token",function(b){this.remove();x();""==a.getValue()&&(f.removeClass("zui-autosuggestion-with-token"),""==k&&(p="",l.html(z)));(function(){l.show().top(c.top()).left(c.left())}).delay(50)});!b.multichoice||""==k||"id"!=b.usedproperty&&"text"!=b.usedproperty||("id"==b.usedproperty?zjs.foreach(k.split(/\s*,\s*/),function(a){u.asyncGetItemById(a,function(a){a&&(zjs('<div class="zui-autosuggestion-token"></div>').html(a.text).setAttr("data-value",a[b.usedproperty]).insertBefore(c),
x())})}):"text"==b.usedproperty&&zjs.foreach(k.split(/\s*,\s*/),function(a){u.asyncSearch(a,function(a){0>=a.length||(a=a[0],zjs('<div class="zui-autosuggestion-token"></div>').html(a.text).setAttr("data-value",a[b.usedproperty]).insertBefore(c),x())})}),f.addClass("zui-autosuggestion-with-token"),c.setValue(k=""),l.hide())}};zjs.extendMethod({makeAutosuggestion:function(d){return this.each(function(h){H(h,d)})},autosuggestionAddindex:function(d){return this.each(function(h){var a=zjs(h);h=a.getData("zjsmoduleautosuggestiondictionary");
a=a.getData("zjsmoduleautosuggestionoption");h&&h.addIndex(d,a.searchproperty)})},autosuggestionRemoveindex:function(d,h){return this.each(function(a){(a=zjs(a).getData("zjsmoduleautosuggestiondictionary"))&&a.removeIndex(d,h)})},autosuggestionFocus:function(){return this.each(function(d){(d=zjs(d).getData("zmoduleautosuggestionwrapinputel"))&&d.trigger("click")})},autosuggestionSetValue:function(d){"undefined"==typeof d&&(d="");return this.each(function(h){var a=zjs(h).getData("zjsmoduleautosuggestionnewinput");
if(a)try{a.value=d,zjs(h).getData("zjsmoduleautosuggestionkeytype")(!0)}catch(b){}})},autosuggestionDisable:function(d){d=d||!1;return this.each(function(h){var a=zjs(h).getData("zjsmoduleautosuggestionnewinput");h=zjs(h).getData("zmoduleautosuggestionwrapel");if(a)try{(a.disabled=d)?h.addClass("disabled"):h.removeClass("disabled")}catch(b){}})}});zjs.hook({after_setInnerHTML:function(d){zjs(d).find(".zautosuggestion").makeAutosuggestion()},after_insertDOM:function(d){zjs(d).is(".zautosuggestion")&&
zjs(d).makeAutosuggestion();zjs(d).find(".zautosuggestion").makeAutosuggestion()}});zjs(function(){zjs(".zautosuggestion").makeAutosuggestion()});"required"in zjs&&zjs.required("ui.autosuggestion")});