zjs.require("ui",function(){zjs.extendCore({moduleUiFreezepanelOption:{freeze:!0,marginTop:0,marginBottom:0,disableOnDesktop:!1,autoDisableWhenWidthLessThan:0,autoDisableWhenWindowWidthLessThan:0,overflowParent:"auto",pendingScrollTime:0,autoHideWhenReach:!1,autoHideSpeed:2E3,autoHideDelay:0,useHeightBuffer:!0,excludeFromFreezingStack:!1,handlerFreezingElement:!1,handlerFreezingMethod:"meet-top"}});var q,K,t,y=function(){return!t.hasClass("zui-scrollbar-usedefault")&&0<parseInt(t.getData("zmodulescrollbarid",
0))},g=[],V=function(d){for(var f=0;f<g.length;f++)if(g[f].el===d)return f;return-1},P=function(d,f,b){b=b||null;var e=V(d);0>e||(g[e].top=null!==b?b:zjs(d).top(),g[e].height=zjs(d).height(),g[e].freezing=f?1:0)},W=function(d){var f=0,b;for(b=0;b<g.length;b++){zjs(g[b].el).setStyle("z-index",g.length-b);if(g[b].el===d)break;if(!g[b].exclude&&g[b].freezing){var e=g[b].top+g[b].height;f<e&&(f=e)}}return f},r=0,k=function(d){return d.getAbsoluteTop()+r},ba=function(d,f){function b(){if(G&&!c.getData("zmoduleuifreezepaneldisablehandlerkey")){var b=
w?y()?t.scrollPosition():q.scrollTop()+r:p.getStyle("scrollTop");V(d);var f=W(d),e=A("checkActivate",B,a,{scrollTop:b,viewTop:f,orgAnchorPosition:H,parentEl:x,freezepanelEl:c});if(C){if(w&&y()){var g=t.getData("zmodulescrollbaroption");g&&g.usecss&&(c.hasClass("zui-freezing")?c.item(0,!0).style.webkitTransform="translate3d(0, "+b+"px, 0)":c.item(0,!0).style.webkitTransform="none")}if(e===D){if(c.hasClass("zui-freezing")){g=x?x.height():K.height();e=c.height();var h=u?k(u):K.height();v=x?k(x):0;w||
(v-=k(p));var m=v+g;m>h&&(m=h);if(p)if(w){var l=b+f-v;l+e>g&&(l=g-e)}else l=b+f,l+e>g+v&&(l=g+v-e);else g=m-a.marginBottom-e,l=b+f+a.marginTop>g?g-b:f+a.marginTop;u&&(l<-e&&(l=-e),f=!1,L<=b?(L=b,f=!1):f=!0,f&&(l+=L-b,0<l&&(l=0,L=b+e)));c.getData("zmoduleuifreezepanelalwayshow")&&(l=0);c.top(l)}P(d,c.hasClass("zui-freezing"),l)}else{if(D=e){g=c.width();e=c.height();m=h=0;var z=c.getAbsoluteTop();Q=1>=Math.abs(g-c.parent().width());try{h=c.getStyle("margin-top"),m=c.getStyle("margin-bottom")}catch(ca){}n=
zjs("<div>");a.useHeightBuffer&&n.insertBefore(c);n.setStyle({height:e,"margin-top":h,"margin-bottom":m}).addClass("zui-freezepanel-height-buffer");c.setData("zmoduleuifreezepanelbufferel",n);(function(){n&&n.height(c.height())}).delay(50);l=a.marginTop+f;p&&(l=w?b+f-v:l+(b+f));c.addClass("zui-freezing");E?(E=!1,c.top(z-b),setTimeout(function(){c.top(l)})):c.top(l);c.width(g);0<a.pendingScrollTime&&(M=!0,function(){M=!1}.delay(a.pendingScrollTime))}else X();P(d,c.hasClass("zui-freezing"))}}else P(d,
0),e!=D&&(D=e)}}function e(){N&&(c.removeClass("zui-freezing").top(null).width(null),n&&(n.remove(),n=null),N=!1)}function X(){Q=!1;N=!0;if(E&&n){E=!1;var a=n.getAbsoluteTop(),b=y()?t.scrollPosition():q.scrollTop()+r;c.top(a-b);(function(){e()}).delay(300)}else e();c.setData("zmoduleuifreezepanelbufferel",null)}var c=zjs(d),a=c.getData("zmoduleuifreezepaneloption");if(a)c.setData("zmoduleuifreezepaneloption",zjs.extend(a,f));else{a=zjs.clone(zjs.moduleUiFreezepanelOption);var h=c.getAttr("data-option",
"");zjs.isString(h)&&""!=h.trim()&&(a=zjs.extend(a,h.jsonDecode()));c.removeAttr("data-option");"undefined"!=typeof f&&(a=zjs.extend(a,f));if(a.disableOnDesktop&&!zjs.isMobileDevice())return c.setData("zmoduleuifreezepaneloption",a),this;a.autoDisableWhenWidthLessThan=parseInt(a.autoDisableWhenWidthLessThan);0>a.autoDisableWhenWidthLessThan&&(a.autoDisableWhenWidthLessThan=0);a.autoDisableWhenWindowWidthLessThan=parseInt(a.autoDisableWhenWindowWidthLessThan);0>a.autoDisableWhenWindowWidthLessThan&&
(a.autoDisableWhenWindowWidthLessThan=0);a.handlerFreezingMethod in R||(a.handlerFreezingMethod="meet-top");a.excludeFromFreezingStack=!!a.excludeFromFreezingStack;var x=!1,p=!1;h=d;for(var F=!1,J=!1,w=!0;h;){h=h.parentNode;if(h==document.body||h==document){h=!1;break}!F&&zjs(h).hasClass("zfreezepanelwrap")&&(F=!0,x=zjs(h),c.setData("zmoduleuifreezepanelparentwrap",x));if("auto"==a.overflowParent&&!J){var I=zjs(h).getStyle("overflow");if("auto"===I||"scroll"===I)if(p=zjs(h),p.addClass("zui-freezepanel-scroll-wrap"),
c.setData("zmoduleuifreezepaneloverflowparentwrap",p).addClass("zui-freeze-absolute"),J=!0,I=p.getStyle("overflow-y"),"auto"===I||"scroll"===I)w=!1}}c.addClass("zui-freezepanel");var A=R[a.handlerFreezingMethod],B=a.handlerFreezingElement?zjs(a.handlerFreezingElement):c;B.item(0,!0)===c.item(0,!0)&&"scroll-over"==a.handlerFreezingMethod&&(a.handlerFreezingMethod="meet-top",a.handlerFreezingElement=!1,A=R[a.handlerFreezingMethod]);var u=!1;zjs.isString(a.autoHideWhenReach)?(u=zjs(a.autoHideWhenReach),
u=1>u.count()?a.autoHideWhenReach=!1:u.item(0)):zjs.isNumeric(a.autoHideWhenReach)&&(u={getAbsoluteTop:function(){return a.autoHideWhenReach}});var m=!1;a.autoHideSpeed=parseInt(a.autoHideSpeed,10);a.autoHideDelay=parseInt(a.autoHideDelay,10);if(isNaN(a.autoHideDelay)||0>a.autoHideDelay)a.autoHideDelay=0;isNaN(a.autoHideSpeed)||0>a.autoHideSpeed?a.autoHideSpeed=0:m=zjs.timer({from:0,to:0,time:a.autoHideSpeed,onStart:function(a,b){r=a;S()},onProcess:function(a,b,c){r=a;S()},onFinish:function(a,b){r=
b;S()}});c.setData("zmoduleuifreezepaneloption",a);g.push({el:d,zEl:c,top:k(c),height:0,freezing:0,viewTop:0,exclude:a.excludeFromFreezingStack});g.sort(function(a,b){return a.el===b.el?0:a.el.compareDocumentPosition?a.el.compareDocumentPosition(b.el)&2?1:-1:a.el.sourceIndex-b.el.sourceIndex});q=q||zjs(window);t=t||zjs(document.body);K=K||zjs(document);var H=A("getAnchorPosition",B),v=0,z=0,G=!0,C=!0,E=!1;x&&(v=k(x));p&&(z=k(p));w?y()&&(G=!1,t.on("scrollbar:ready",function(){H=A("getAnchorPosition",
B);G=!0})):(H-=z,v-=z);var n,D=!1,Q=!1,M=!1,L=c.height(),N=!1,O=function(){C&&(D=C=!1,X())},T=function(){C||(N&&e(),C=!0,D=!1,b())},Y=function(){0<a.autoDisableWhenWidthLessThan&&(c.width()<=a.autoDisableWhenWidthLessThan?O():T());0<a.autoDisableWhenWindowWidthLessThan&&(q.width()<=a.autoDisableWhenWindowWidthLessThan?O():T());var d=0,e=c.getData("zmoduleuifreezepaneldisablechangeheightbufferkey");n&&(e||n.height(c.height()),d=k(n));p&&(z=k(p));w?y()||(H=0!=d&&C&&c.hasClass("zui-freezing")?A("getAnchorPositionWhenActivated",
B,a,{estimateOrgTop:d}):A("getAnchorPosition",B)):(H-=z,v-=z);b();Q&&c.width(c.parent().width())};c.on("trigger:refreshpanel",Y);q.on("resize",function(){Y.delay(100)});if(y())t.on("scrollbar:scroll",function(){b()});if(w){var aa=function(){if(!c.getData("zmoduleuifreezepaneldisableshowhide",!1)){var a=q.scrollTop(),b=Z-a;0>b?b=-1:0<b&&(b=1);Z=a;0!==b&&b!=U&&(m.stop(),U=b);if(!m.isRunning()){a=2*c.height();var d=u.getAbsoluteTop()-q.scrollTop();0>=d&&0>b&&r<a&&(m.isRunning()||m.set({from:r,to:a}).run());
0>=d&&0<b&&0<r&&(b!=U&&m.stop(),m.isRunning()||m.set({from:r,to:0}).run())}}};if(0<a.pendingScrollTime)q.on("mousewheel",function(a){M&&(a.stopPropagation(),a.preventDefault())});var U=0,Z=0;q.on("scroll",function(c){M||y()||(!G&&zjs(document.body).hasClass("zui-scrollbar-usedefault")&&(G=!0),b(),0>=a.autoHideSpeed||!u||(0<a.autoHideDelay?aa.delay(a.autoHideDelay):aa()))})}else p.on("scroll",b);a.freeze?b():(O(),c.on("trigger:enablefreeze",function(a){E=a.getData()&&a.getData().effect;T()}),c.on("trigger:disablefreeze",
function(a){E=a.getData()&&a.getData().effect;O()}));c.trigger("ui:freezepanel:load")}},J=function(d){zjs(d).trigger("trigger:refreshpanel")},S=function(){g.map(function(d){d.zEl.trigger("trigger:refreshpanel")})},R={"meet-top":function(d,f,b,e){if("getAnchorPosition"==d)return k(f);if("getAnchorPositionWhenActivated"==d)return b.handlerFreezingElement?k(f):e.estimateOrgTop;if("checkActivate"==d)return e.parentEl&&e.freezepanelEl.height()>=e.parentEl.height()?!1:e.scrollTop+e.viewTop>=e.orgAnchorPosition-
b.marginTop},"scroll-over":function(d,f,b,e){if("getAnchorPosition"==d)return k(f)+f.height();if("getAnchorPositionWhenActivated"==d)return b.handlerFreezingElement?k(f)+f.height():e.estimateOrgTop+f.height();if("checkActivate"==d)return e.scrollTop+e.viewTop>=e.orgAnchorPosition}},F=function(d,f){var b=zjs(f);if(!b.getData("zmoduleuifreezepaneloption")){for(var e=!1,g,c=b.parent(!0).item(0,!0);c&&c!=document.body;){g=zjs(c);if(g.getData("zmoduleuifreezepaneloption")){e=!0;break}c=g.parent(!0).item(0,
!0)}return e?g.hasClass("zui-freezing")?k(b)+F(d,c):k(b):k(b)}if(!b.hasClass("zui-freezing"))return k(b);e=b.getData("zmoduleuifreezepanelbufferel",null);if("original"==d)return e?k(e):k(b);b=k(b);e=e=y()?t.scrollPosition():q.scrollTop()+r;return e+b};zjs.extendMethod({makeFreezepanel:function(d){return this.eachElement(function(f){ba(f,d)})},freezepanelGetOriginalTop:function(){return F("original",this.item(0))},freezepanelGetAbsoluteTop:function(){return F("absolute",this.item(0))},freezepanelRefresh:function(){return this.eachElement(function(d){J(d)})},
freezepanelDisableAutoShowHide:function(d){return this.eachElement(function(f){zjs(f).setData("zmoduleuifreezepaneldisableshowhide",d)})},freezepanelAlwayShow:function(d){return this.eachElement(function(f){var b=zjs(f),e=b.getData("zmoduleuifreezepaneloption");b.setData("zmoduleuifreezepaneldisableshowhide",d);b.setData("zmoduleuifreezepanelalwayshow",d);e.freeze?J(f):d?b.trigger("trigger:enablefreeze",{effect:!0}):b.trigger("trigger:disablefreeze",{effect:!0})})},freezepanelDisableChangeHeightBuffer:function(d){return this.eachElement(function(f){zjs(f).setData("zmoduleuifreezepaneldisablechangeheightbufferkey",
d)})},freezepanelDisableHandler:function(d){return this.eachElement(function(f){zjs(f).setData("zmoduleuifreezepaneldisablehandlerkey",d)})}});zjs.extendCore({freezepanelGetVisibleFreezingHeight:function(){return W(window)}});zjs.hook({after_setInnerHTML:function(d){zjs(d).find(".zfreezepanel").makeFreezepanel()},after_insertDOM:function(d){zjs(d).hasClass("zfreezepanel")&&zjs(d).makeFreezepanel();zjs(d).find(".zfreezepanel").makeFreezepanel()}});zjs.onready(function(){zjs(".zfreezepanel").makeFreezepanel()});
"required"in zjs&&zjs.required("ui.freezepanel")});