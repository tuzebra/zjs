(function(p,g){var e=function(a,d){this.datas=[];this.lastSearchIndexs=[];this.indexDictionary=[];this.indexId=[];this.indexWord=[];this.addIndex(a,d);this.cacheResponse=!0;this.usedCacheDataSource=!1;this.dataSourceDataStructure=this.dataSourceUrl="";this.defaultSearchProperty=d||"text";this.lastRawquery="";this.dataSourceUrlIsLoaded=!1;return this};e.prototype.setCacheResponse=function(a){this.cacheResponse=a};e.prototype.useCacheDataSource=function(a){this.usedCacheDataSource=a};e.prototype.setDataSourceUrl=
function(a){this.dataSourceUrl=a};e.prototype.setDataSourceDataStructure=function(a){this.dataSourceDataStructure=a};e.prototype.addIndex=function(a,d){if("undefined"==typeof a||"function"==typeof a)return this;if(a.constructor===Array){for(var c=0;c<a.length;c++)this.addIndex(a[c],d);return this}if("object"==typeof a&&"id.text"==d){for(var b in a)this.addIndex({id:b,text:a[b]},"text");return this}this.defaultSearchProperty=d=d||"text";c="";b={};"string"==typeof a&&(c=a);"object"==typeof a&&(c=a[d]||
"",b=a);if("object"==typeof b&&("id"in b||""===c||(b.id=c),this.getItemById(b.id)))return;this.datas.push(g.extend(b,{text:c.toString()}));var f=this.datas.length-1;c=c.toString().removeVietnameseCharacter().toLowerCase();var l=c.split(" ");for(c=0;c<l.length;c++){var k=l[c];if("undefined"==typeof this.indexDictionary[k]||this.indexDictionary[k].constructor!==Array)this.indexDictionary[k]=[],this.indexWord.push(k);this.indexDictionary[k].push(f)}"id"in b&&(this.indexId[b.id]=f);return this};e.prototype.removeIndex=
function(a,d){"string"!=typeof a&&(a="");"function"!=typeof d&&(d=function(){return!0});this.search(a);var c;for(c=0;c<this.lastSearchIndexs.length;c++){var b=this.lastSearchIndexs[c];!0===d(this.datas[b])&&(this.datas[b]=null)}return this};e.prototype.resetIndex=function(){this.datas=[];this.lastSearchIndexs=[];this.indexDictionary=[];this.indexId=[];this.indexWord=[];return this};e.prototype.getItemById=function(a){return!a in this.indexId?!1:this.datas[this.indexId[a]]};e.prototype.search=function(a){var d=
a.removeVietnameseCharacter().toLowerCase();a=[];var c=d.split(" "),b,f,l=-1,k=c.length;for(b=0;b<k;b++){var e=c[b];var g=[];var n=[];var m=[];for(f=0;f<this.indexWord.length;f++)l=this.indexWord[f].indexOf(e),0<=l&&m.push({keyword:this.indexWord[f],strong:e.length/this.indexWord[f].length+(0===l?.2*(k-b):0)});for(f=0;f<m.length;f++)for(e=0;e<this.indexDictionary[m[f].keyword].length;e++)g[this.indexDictionary[m[f].keyword][e].toString()]=m[f].strong;for(var h in g)(0==b||h in a)&&"function"!=typeof g[h]&&
h in this.datas&&null!=this.datas[h]&&(n[h]={index:h,idof:"string"===typeof this.datas[h].text?this.datas[h].text.removeVietnameseCharacter().toLowerCase().indexOf(d):-1,strong:g[h]});a=n}a.sort(function(a,b){return 0===a.idof&&0===b.idof||0!==a.idof&&0!==b.idof?b.strong-a.strong:0===a.idof?-1:1});this.lastSearchIndexs=[];h=[];for(b=0;b<a.length;b++)"object"===typeof a[b]&&(h.push(this.datas[a[b].index]),this.lastSearchIndexs.push(a[b].index));return h};e.prototype.getDataFromDataSource=function(a,
d){var c=this;if(c.dataSourceUrlIsLoaded)g.isFunction(d)&&d();else{c.usedCacheDataSource&&(c.dataSourceUrlIsLoaded=!0);var b=a||"";g.isString(b)&&(b=b.toLowerCase());g.ajax({url:this.dataSourceUrl,data:{f:"text",q:b},type:"json",method:"get",cache:this.cacheResponse,cacheResponse:this.cacheResponse,onBegin:!1,onLoading:!1,onComplete:function(a){if(""!=c.dataSourceDataStructure){var b=c.dataSourceDataStructure.split(".");if(1<b.length&&""==b[0])for(var f=1;f<b.length;f++)a=a[b[f]]}c.addIndex(a,c.defaultSearchProperty);
g.isFunction(d)&&d(a)},onError:!1,debug:!1})}};e.prototype.asyncGetItemById=function(a,d){var c=this.getItemById(a);if(c)g.isFunction(d)&&d(c);else if(""!=this.dataSourceUrl){var b=this;g.ajax({url:this.dataSourceUrl,data:{f:"id",id:a},type:"json",method:"get",cache:!1,onBegin:!1,onLoading:!1,onComplete:function(c){if(""!=b.dataSourceDataStructure){var f=b.dataSourceDataStructure.split(".");if(1<f.length&&""==f[0])for(var e=1;e<f.length;e++)c=c[f[e]]}b.addIndex(c,b.defaultSearchProperty);(c=b.getItemById(a))&&
g.isFunction(d)&&d(c)},onError:!1,debug:!1})}};e.prototype.asyncSearch=function(a,d){this.lastRawquery=a;var c=this.search(a);g.isFunction(d)&&d(c);if(""!=this.dataSourceUrl){var b=this;this.getDataFromDataSource(a,function(){var c=b.search(a);g.isFunction(d)&&a==b.lastRawquery&&d(c)})}};g.extendCore({dictionary:e});g.required("dictionary")})(window,zjs);