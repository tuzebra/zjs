(function(q,g){var h=function(a,d){this.datas=[];this.lastSearchIndexs=[];this.indexDictionary=[];this.indexId=[];this.indexWord=[];this.addIndex(a,d);this.cacheResponse=!0;this.usedCacheDataSource=!1;this.dataSourceDataStructure=this.dataSourceUrl="";this.defaultSearchProperty=d||"text";this.lastRawquery="";this.searchResultLimit=0;this.dataSourceUrlIsLoaded=this.searchMatchStartWith=!1;return this};h.prototype.setSearchMatchStartWith=function(a){this.searchMatchStartWith=!0};h.prototype.setDefaultSearchResultLimit=
function(a){this.searchResultLimit=a};h.prototype.setCacheResponse=function(a){this.cacheResponse=a};h.prototype.useCacheDataSource=function(a){this.usedCacheDataSource=a};h.prototype.setDataSourceUrl=function(a){this.dataSourceUrl=a};h.prototype.setDataSourceDataStructure=function(a){this.dataSourceDataStructure=a};h.prototype.addIndex=function(a,d){if("undefined"==typeof a||"function"==typeof a)return this;if(a.constructor===Array){for(var b=0;b<a.length;b++)this.addIndex(a[b],d);return this}if("object"==
typeof a&&"id.text"==d){for(var c in a)this.addIndex({id:c,text:a[c]},"text");return this}this.defaultSearchProperty=d=d||"text";b="";c={};"string"==typeof a&&(b=a);"object"==typeof a&&(b=a[d]||"",c=a);if("object"==typeof c&&("id"in c||""===b||(c.id=b),this.getItemById(c.id)))return;this.datas.push(g.extend(c,{text:b.toString()}));var e=this.datas.length-1;b=b.toString().removeVietnameseCharacter().toLowerCase();var f=b.split(" ");for(b=0;b<f.length;b++){var k=f[b];if("undefined"==typeof this.indexDictionary[k]||
this.indexDictionary[k].constructor!==Array)this.indexDictionary[k]=[],this.indexWord.push(k);this.indexDictionary[k].push(e)}"id"in c&&(this.indexId[c.id]=e);return this};h.prototype.removeIndex=function(a,d){"string"!=typeof a&&(a="");"function"!=typeof d&&(d=function(){return!0});this.search(a);var b;for(b=0;b<this.lastSearchIndexs.length;b++){var c=this.lastSearchIndexs[b];!0===d(this.datas[c])&&(this.datas[c]=null)}return this};h.prototype.resetIndex=function(){this.datas=[];this.lastSearchIndexs=
[];this.indexDictionary=[];this.indexId=[];this.indexWord=[];return this};h.prototype.getItemById=function(a){return!a in this.indexId?!1:this.datas[this.indexId[a]]};h.prototype.getItemsLimit=function(a){a=a||this.searchResultLimit;return 0>=a?this.datas:this.datas.slice(0,a)};h.prototype.search=function(a){var d=a.removeVietnameseCharacter().toLowerCase(),b=[],c=d.split(" "),e,f,k=-1,h=c.length;for(e=0;e<h;e++){var g=c[e];var m=[];var p=[];var n=[];for(f=0;f<this.indexWord.length;f++)k=this.indexWord[f].indexOf(g),
0<=k&&n.push({keyword:this.indexWord[f],strong:g.length/this.indexWord[f].length+(0===k?.2*(h-e):0)});for(f=0;f<n.length;f++)for(g=0;g<this.indexDictionary[n[f].keyword].length;g++)m[this.indexDictionary[n[f].keyword][g].toString()]=n[f].strong;for(var l in m)(0==e||l in b)&&"function"!=typeof m[l]&&l in this.datas&&null!=this.datas[l]&&(p[l]={index:l,idof:"string"===typeof this.datas[l].text?this.datas[l].text.removeVietnameseCharacter().toLowerCase().indexOf(d):-1,strong:m[l]});b=p}b.sort(function(a,
b){return 0===a.idof&&0===b.idof||0!==a.idof&&0!==b.idof?b.strong-a.strong:0===a.idof?-1:1});this.lastSearchIndexs=[];d=[];c=this.searchResultLimit;for(e=0;e<b.length&&!("object"===typeof b[e]&&(f=!0,this.searchMatchStartWith&&(n=a.toLowerCase(),m=this.datas[b[e].index],m=m.text.toLowerCase(),0!==m.indexOf(n)&&(f=!1)),f&&(d.push(this.datas[b[e].index]),this.lastSearchIndexs.push(b[e].index),0<this.searchResultLimit&&(c--,0>=c))));e++);return d};h.prototype.getDataFromDataSource=function(a,d){var b=
this;if(b.dataSourceUrlIsLoaded)g.isFunction(d)&&d();else{b.usedCacheDataSource&&(b.dataSourceUrlIsLoaded=!0);var c=a||"";g.isString(c)&&(c=c.toLowerCase());c={f:"text",q:c};0<this.searchResultLimit&&(c.limit=this.searchResultLimit);g.ajax({url:this.dataSourceUrl,data:c,type:"json",method:"get",cache:this.cacheResponse,cacheResponse:this.cacheResponse,onBegin:!1,onLoading:!1,onComplete:function(a){if(""!=b.dataSourceDataStructure){var c=b.dataSourceDataStructure.split(".");if(1<c.length&&""==c[0])for(var e=
1;e<c.length;e++)a=a[c[e]]}b.addIndex(a,b.defaultSearchProperty);g.isFunction(d)&&d(a)},onError:!1,debug:!1})}};h.prototype.asyncGetItemById=function(a,d){var b=this.getItemById(a);if(b)g.isFunction(d)&&d(b);else if(""!=this.dataSourceUrl){var c=this;g.ajax({url:this.dataSourceUrl,data:{f:"id",id:a},type:"json",method:"get",cache:!1,onBegin:!1,onLoading:!1,onComplete:function(b){if(""!=c.dataSourceDataStructure){var f=c.dataSourceDataStructure.split(".");if(1<f.length&&""==f[0])for(var e=1;e<f.length;e++)b=
b[f[e]]}c.addIndex(b,c.defaultSearchProperty);(b=c.getItemById(a))&&g.isFunction(d)&&d(b)},onError:!1,debug:!1})}};h.prototype.asyncSearch=function(a,d){this.lastRawquery=a;var b=this.search(a);g.isFunction(d)&&d(b);if(""!=this.dataSourceUrl){var c=this;this.getDataFromDataSource(a,function(){var b=c.search(a);g.isFunction(d)&&a==c.lastRawquery&&d(b)})}};g.extendCore({dictionary:h});g.required("dictionary")})(window,zjs);