(function(t,e){"use strict";function i(t,e){var i;return function(){var r=this,o=arguments;clearTimeout(i),i=setTimeout(function(){i=null,t.apply(r,o)},e)}}var r=function(t,e){return this.datas=[],this.lastSearchIndexs=[],this.indexDictionary=[],this.indexId=[],this.indexWord=[],this.addIndex(t,e),this.cacheResponse=!0,this.usedCacheDataSource=!1,this.dataSourceUrl=null,this.sourceUrlValueSelector=null,this.dataSourceDataStructure="",this.dataSourceDataSelector="",this.defaultSearchProperty=e||"text",this.lastRawquery="",this.searchResultLimit=0,this.searchMatchStartWith=!1,this.dataSourceUrlIsLoaded=!1,this.countXhrRequesting=0,this.onStartXhrRequesting=null,this.onEndXhrRequesting=null,this.itemFilterFunction=null,this};r.prototype.setSearchMatchStartWith=function(t){this.searchMatchStartWith=!0},r.prototype.setDefaultSearchResultLimit=function(t){this.searchResultLimit=t},r.prototype.setCacheResponse=function(t){this.cacheResponse=t},r.prototype.useCacheDataSource=function(t){this.usedCacheDataSource=t},r.prototype.setDataSourceUrl=function(t){this.dataSourceUrl=t},r.prototype.setDataSourceDataStructure=function(t){this.dataSourceDataStructure=t},r.prototype.setDataSourceDataSelector=function(t){this.dataSourceDataSelector=t},r.prototype.setDataSourceUrlValueSelector=function(t){this.sourceUrlValueSelector=t},r.prototype.setOnStartEndLoading=function(t,e){this.onStartXhrRequesting=t,this.onEndXhrRequesting=e},r.prototype.setItemFilterFunction=function(t){this.itemFilterFunction=t},r.prototype.addIndex=function(t,i){if(void 0===t||"function"==typeof t||null==t)return this;if(t.constructor===Array){for(var r=0;r<t.length;r++)this.addIndex(t[r],i);return this}if("object"==typeof t&&"id.text"==i){for(var o in t)this.addIndex({id:o,text:t[o]},"text");return this}i=i||"text",this.defaultSearchProperty=i;var a="",n=new Object;if("string"==typeof t&&(a=t),"object"==typeof t&&(a=t[i]||"",n=t),"object"!=typeof n||("id"in n||""===a||(n.id=a),!this.getItemById(n.id))){this.datas.push(e.extend(n,{text:a.toString()}));var s=this.datas.length-1;a=a.toString().removeVietnameseCharacter().toLowerCase();var c=a.split(" "),u="";for(r=0;r<c.length;r++)u=c[r],void 0!==this.indexDictionary[u]&&this.indexDictionary[u].constructor===Array||(this.indexDictionary[u]=[],this.indexWord.push(u)),this.indexDictionary[u].push(s);return"id"in n&&(this.indexId[n.id]=s),this}},r.prototype.removeIndex=function(t,e){"string"!=typeof t&&(t=""),"function"!=typeof e&&(e=function(){return!0});var i,r;this.search(t);for(i=0;i<this.lastSearchIndexs.length;i++)r=this.lastSearchIndexs[i],!0===e(this.datas[r])&&(this.datas[r]=null);return this},r.prototype.resetIndex=function(){return this.datas=[],this.lastSearchIndexs=[],this.indexDictionary=[],this.indexId=[],this.indexWord=[],this},r.prototype.getItemById=function(t){return!(!t in this.indexId)&&this.datas[this.indexId[t]]},r.prototype.getItemsLimit=function(t){t=t||this.searchResultLimit;var e=t<=0?this.datas.slice():this.datas.slice(0,t);return"function"==typeof this.itemFilterFunction?e.filter(this.itemFilterFunction):e},r.prototype.search=function(t){var e,i,r,o,a,n,s,c=t.removeVietnameseCharacter().toLowerCase(),u=[],h=c.split(" "),d=-1,l=h.length;for(e=0;e<l;e++){for(o=h[e],n=[],s=[],a=[],i=0;i<this.indexWord.length;i++)d=this.indexWord[i].indexOf(o),d>=0&&a.push({keyword:this.indexWord[i],strong:o.length/this.indexWord[i].length+(0===d?.2*(l-e):0)});for(i=0;i<a.length;i++)for(r=0;r<this.indexDictionary[a[i].keyword].length;r++)n[this.indexDictionary[a[i].keyword][r].toString()]=a[i].strong;for(var f in n)(0==e||f in u)&&"function"!=typeof n[f]&&f in this.datas&&null!=this.datas[f]&&(s[f]={index:f,idof:"string"==typeof this.datas[f].text?this.datas[f].text.removeVietnameseCharacter().toLowerCase().indexOf(c):-1,strong:n[f]});u=s}u.sort(function(t,e){return 0===t.idof&&0===e.idof||0!==t.idof&&0!==e.idof?e.strong-t.strong:0===t.idof?-1:1}),this.lastSearchIndexs=[];var p=[],S=this.searchResultLimit;for(e=0;e<u.length;e++)if("object"==typeof u[e]){var y=!0;if(this.searchMatchStartWith){var g=t.toLowerCase(),x=this.datas[u[e].index];x=x.text.toLowerCase(),0!==x.indexOf(g)&&(y=!1)}if(y&&(p.push(this.datas[u[e].index]),this.lastSearchIndexs.push(u[e].index),this.searchResultLimit>0&&(S--,S<=0)))break}return"function"==typeof this.itemFilterFunction?p.filter(this.itemFilterFunction):p},r.prototype.getDataFromDataSource=i(function(t,i){var r=this;if(r.dataSourceUrlIsLoaded)e.isFunction(i)&&i();else{r.usedCacheDataSource&&(r.dataSourceUrlIsLoaded=!0);var o=t||"";e.isString(o)&&(o=o.toLowerCase());var a={f:"text",q:o};r.searchResultLimit>0&&(a.limit=r.searchResultLimit),"function"==typeof r.sourceUrlValueSelector&&(a=r.sourceUrlValueSelector(a)),r.countXhrRequesting++,1==r.countXhrRequesting&&"function"==typeof r.onStartXhrRequesting&&r.onStartXhrRequesting(),e.ajax({url:"function"==typeof r.dataSourceUrl?r.dataSourceUrl(a):r.dataSourceUrl,data:a,type:"json",method:"get",cache:r.cacheResponse,cacheResponse:r.cacheResponse,onBegin:!1,onLoading:!1,onResponse:function(t,o){r.countXhrRequesting--,r.countXhrRequesting||"function"!=typeof r.onEndXhrRequesting||r.onEndXhrRequesting();var n=[];if(""!=r.dataSourceDataStructure){var s=r.dataSourceDataStructure.split(".");if(s.length>1&&""==s[0])for(var c=1;c<s.length;c++)t&&"object"==typeof t&&t[s[c]]&&(t=t[s[c]])}n="function"==typeof r.dataSourceDataSelector?r.dataSourceDataSelector(t,a):t,r.addIndex(n,r.defaultSearchProperty),e.isFunction(i)&&i(n)},onError:!1,debug:!1})}},650),r.prototype.asyncGetItemById=function(t,i){var r=this.getItemById(t);if(r)e.isFunction(i)&&i(r);else if(this.dataSourceUrl){var o=this,a={f:"id",id:t};"function"==typeof this.sourceUrlValueSelector&&(a=this.sourceUrlValueSelector(a)),e.ajax({url:"function"==typeof this.dataSourceUrl?this.dataSourceUrl(a):this.dataSourceUrl,data:a,type:"json",method:"get",cache:!1,onBegin:!1,onLoading:!1,onComplete:function(r){var n=[];if(""!=o.dataSourceDataStructure){var s=o.dataSourceDataStructure.split(".");if(s.length>1&&""==s[0])for(var c=1;c<s.length;c++)r=r[s[c]]}n="function"==typeof o.dataSourceDataSelector?o.dataSourceDataSelector(r,a):r,o.addIndex(n,o.defaultSearchProperty),n=o.getItemById(t),n&&e.isFunction(i)&&i(n)},onError:!1,debug:!1})}},r.prototype.asyncSearch=function(t,i){this.lastRawquery=t;var r=this.search(t);if(e.isFunction(i)&&i(r,!1),this.dataSourceUrl){var o=this;this.getDataFromDataSource(t,function(){var r=o.search(t);e.isFunction(i)&&t==o.lastRawquery&&i(r,!0)})}},e.extendCore({dictionary:r}),e.required("dictionary")})(window,zjs);