(function(t,e){"use strict";function r(t,e){var r;return function(){var i=this,a=arguments;clearTimeout(r),r=setTimeout(function(){r=null,t.apply(i,a)},e)}}var i=function(t,e){return this.datas=[],this.lastSearchIndexs=[],this.indexDictionary=[],this.indexId=[],this.indexWord=[],this.addIndex(t,e),this.cacheResponse=!0,this.usedCacheDataSource=!1,this.dataSourceUrl=null,this.sourceUrlValueSelector=null,this.dataSourceDataStructure="",this.dataSourceDataSelector="",this.defaultSearchProperty=e||"text",this.lastRawquery="",this.searchResultLimit=0,this.searchMatchStartWith=!1,this.dataSourceUrlIsLoaded=!1,this.countXhrRequesting=0,this.onStartXhrRequesting=null,this.onEndXhrRequesting=null,this};i.prototype.setSearchMatchStartWith=function(t){this.searchMatchStartWith=!0},i.prototype.setDefaultSearchResultLimit=function(t){this.searchResultLimit=t},i.prototype.setCacheResponse=function(t){this.cacheResponse=t},i.prototype.useCacheDataSource=function(t){this.usedCacheDataSource=t},i.prototype.setDataSourceUrl=function(t){this.dataSourceUrl=t},i.prototype.setDataSourceDataStructure=function(t){this.dataSourceDataStructure=t},i.prototype.setDataSourceDataSelector=function(t){this.dataSourceDataSelector=t},i.prototype.setDataSourceUrlValueSelector=function(t){this.sourceUrlValueSelector=t},i.prototype.setOnStartEndLoading=function(t,e){this.onStartXhrRequesting=t,this.onEndXhrRequesting=e},i.prototype.addIndex=function(t,r){if(void 0===t||"function"==typeof t||null==t)return this;if(t.constructor===Array){for(var i=0;i<t.length;i++)this.addIndex(t[i],r);return this}if("object"==typeof t&&"id.text"==r){for(var a in t)this.addIndex({id:a,text:t[a]},"text");return this}r=r||"text",this.defaultSearchProperty=r;var o="",n=new Object;if("string"==typeof t&&(o=t),"object"==typeof t&&(o=t[r]||"",n=t),"object"!=typeof n||("id"in n||""===o||(n.id=o),!this.getItemById(n.id))){this.datas.push(e.extend(n,{text:o.toString()}));var s=this.datas.length-1;o=o.toString().removeVietnameseCharacter().toLowerCase();var c=o.split(" "),h="";for(i=0;i<c.length;i++)h=c[i],void 0!==this.indexDictionary[h]&&this.indexDictionary[h].constructor===Array||(this.indexDictionary[h]=[],this.indexWord.push(h)),this.indexDictionary[h].push(s);return"id"in n&&(this.indexId[n.id]=s),this}},i.prototype.removeIndex=function(t,e){"string"!=typeof t&&(t=""),"function"!=typeof e&&(e=function(){return!0});var r,i;this.search(t);for(r=0;r<this.lastSearchIndexs.length;r++)i=this.lastSearchIndexs[r],!0===e(this.datas[i])&&(this.datas[i]=null);return this},i.prototype.resetIndex=function(){return this.datas=[],this.lastSearchIndexs=[],this.indexDictionary=[],this.indexId=[],this.indexWord=[],this},i.prototype.getItemById=function(t){return!(!t in this.indexId)&&this.datas[this.indexId[t]]},i.prototype.getItemsLimit=function(t){return t=t||this.searchResultLimit,t<=0?this.datas:this.datas.slice(0,t)},i.prototype.search=function(t){var e,r,i,a,o,n,s,c=t.removeVietnameseCharacter().toLowerCase(),h=[],u=c.split(" "),d=-1,l=u.length;for(e=0;e<l;e++){for(a=u[e],n=[],s=[],o=[],r=0;r<this.indexWord.length;r++)d=this.indexWord[r].indexOf(a),d>=0&&o.push({keyword:this.indexWord[r],strong:a.length/this.indexWord[r].length+(0===d?.2*(l-e):0)});for(r=0;r<o.length;r++)for(i=0;i<this.indexDictionary[o[r].keyword].length;i++)n[this.indexDictionary[o[r].keyword][i].toString()]=o[r].strong;for(var f in n)(0==e||f in h)&&"function"!=typeof n[f]&&f in this.datas&&null!=this.datas[f]&&(s[f]={index:f,idof:"string"==typeof this.datas[f].text?this.datas[f].text.removeVietnameseCharacter().toLowerCase().indexOf(c):-1,strong:n[f]});h=s}h.sort(function(t,e){return 0===t.idof&&0===e.idof||0!==t.idof&&0!==e.idof?e.strong-t.strong:0===t.idof?-1:1}),this.lastSearchIndexs=[];var S=[],p=this.searchResultLimit;for(e=0;e<h.length;e++)if("object"==typeof h[e]){var y=!0;if(this.searchMatchStartWith){var g=t.toLowerCase(),x=this.datas[h[e].index];x=x.text.toLowerCase(),0!==x.indexOf(g)&&(y=!1)}if(y&&(S.push(this.datas[h[e].index]),this.lastSearchIndexs.push(h[e].index),this.searchResultLimit>0&&(p--,p<=0)))break}return S},i.prototype.getDataFromDataSource=r(function(t,r){var i=this;if(i.dataSourceUrlIsLoaded)e.isFunction(r)&&r();else{i.usedCacheDataSource&&(i.dataSourceUrlIsLoaded=!0);var a=t||"";e.isString(a)&&(a=a.toLowerCase());var o={f:"text",q:a};i.searchResultLimit>0&&(o.limit=i.searchResultLimit),"function"==typeof i.sourceUrlValueSelector&&(o=i.sourceUrlValueSelector(o)),i.countXhrRequesting++,1==i.countXhrRequesting&&"function"==typeof i.onStartXhrRequesting&&i.onStartXhrRequesting(),e.ajax({url:"function"==typeof i.dataSourceUrl?i.dataSourceUrl(o):i.dataSourceUrl,data:o,type:"json",method:"get",cache:i.cacheResponse,cacheResponse:i.cacheResponse,onBegin:!1,onLoading:!1,onResponse:function(t,a){i.countXhrRequesting--,i.countXhrRequesting||"function"!=typeof i.onEndXhrRequesting||i.onEndXhrRequesting();var n=[];if(""!=i.dataSourceDataStructure){var s=i.dataSourceDataStructure.split(".");if(s.length>1&&""==s[0])for(var c=1;c<s.length;c++)t&&"object"==typeof t&&t[s[c]]&&(t=t[s[c]])}n="function"==typeof i.dataSourceDataSelector?i.dataSourceDataSelector(t,o):t,i.addIndex(n,i.defaultSearchProperty),e.isFunction(r)&&r(n)},onError:!1,debug:!1})}},650),i.prototype.asyncGetItemById=function(t,r){var i=this.getItemById(t);if(i)e.isFunction(r)&&r(i);else if(this.dataSourceUrl){var a=this,o={f:"id",id:t};"function"==typeof this.sourceUrlValueSelector&&(o=this.sourceUrlValueSelector(o)),e.ajax({url:"function"==typeof this.dataSourceUrl?this.dataSourceUrl(o):this.dataSourceUrl,data:o,type:"json",method:"get",cache:!1,onBegin:!1,onLoading:!1,onComplete:function(i){var n=[];if(""!=a.dataSourceDataStructure){var s=a.dataSourceDataStructure.split(".");if(s.length>1&&""==s[0])for(var c=1;c<s.length;c++)i=i[s[c]]}n="function"==typeof a.dataSourceDataSelector?a.dataSourceDataSelector(i,o):i,a.addIndex(n,a.defaultSearchProperty),n=a.getItemById(t),n&&e.isFunction(r)&&r(n)},onError:!1,debug:!1})}},i.prototype.asyncSearch=function(t,r){this.lastRawquery=t;var i=this.search(t);if(e.isFunction(r)&&r(i,!1),this.dataSourceUrl){var a=this;this.getDataFromDataSource(t,function(){var i=a.search(t);e.isFunction(r)&&t==a.lastRawquery&&r(i,!0)})}},e.extendCore({dictionary:i}),e.required("dictionary")})(window,zjs);