zjs.require("ui.button",function(){zjs.extendCore({moduleUiButtonFileOption:{name:"",text:"Choose File",data:{},multiple:!0,autoupload:"ajax",autouploadUrl:"",autouploadClear:!0,uploadMultipleFilesAtOneTime:!0,maxFileSize:10485760,maxNumberOfFile:10,allowFileExt:"",notallowFileExt:"php,exe,asp",returntype:"json",uploadingText:"",dropText:"",getFileContent:!1,readEXIF:!1}});var q=function(){var a=!1;window.XMLHttpRequest&&(a=new window.XMLHttpRequest);var c=document.createElement("INPUT");c.type="file";
var e=!!window.FormData;return"files"in c&&a&&a.upload&&"onprogress"in a.upload&&e}(),D=function(a,c){var e=zjs(a),b=e.getData("zmoduleuibuttonfileoption");if(b)e.setData("zmoduleuibuttonfileoption",zjs.extend(b,c));else{var b=zjs.clone(zjs.moduleUiButtonFileOption),m=e.getAttr("data-option","");zjs.isString(m)&&""!=m.trim()&&(b=zjs.extend(b,m.jsonDecode()));e.removeAttr("data-option");"undefined"!=typeof c&&(b=zjs.extend(b,c));m=zjs.enablehook();zjs.enablehook(!1);var p=e.is("input")?"input":"a";
if("input"!=p||e.is("[type=file]")){if("a"==p)var k=zjs(a),f=zjs('<input type="file">');"input"==p&&(f=zjs(a),k=zjs("<a>").html(b.text).insertBefore(f));window.attachEvent&&f.attr("tabIndex",-1);if(b.multiple)try{f.item(0,!0).multiple=!0}catch(r){}"multiple"in f.item(0,!0)&&f.item(0,!0).multiple?b.multiple=!0:(b.multiple=!1,f.item(0,!0).multiple=!1);""==b.name&&""==f.getAttr("name","")&&f.attr("name","uploadfile");""!=b.name&&""==f.getAttr("name","")&&f.attr("name",b.name);b.multiple&&f.attr("name")&&
!f.attr("name").test(/\[\]$/)&&f.attr("name",f.attr("name")+"[]");b.name=f.attr("name");e.setData("zmoduleuibuttonfilebtnel",k);e.setData("zmoduleuibuttonfileinputel",f);""==b.dropText&&(b.dropText="Drop here to upload");k.makeButton().addClass("zui-button-file").style({position:"relative",overflow:"hidden",direction:"ltr"});f.appendTo(k).style({position:"absolute",right:"0px",top:"0px","font-family":"Arial","font-size":"118px",margin:"0px",padding:"0px","min-height":"100%","min-width":"100%",cursor:"pointer",
opacity:0}).hover(function(){f.style("cursor",k.hasClass("disabled")?"default":"pointer");k.addClass("hover")},function(){k.removeClass("hover active")}).on("mousedown",function(){k.addClass("active")}).on("mouseup",function(){k.removeClass("active")});""==b.autouploadUrl&&(b.autoupload="");"ajax"!=b.autoupload||q||(b.autoupload="form");"ajax"==b.autoupload&&q&&(b.uploadMultipleFilesAtOneTime=!!b.uploadMultipleFilesAtOneTime,k.addClass("zui-support-drag-drop").prepend('<span class="zui-button-drop-text">'+
b.dropText+"</span>"),f.on("dragenter",function(b){k.hasClass("disabled")||k.addClass("zui-ready-to-drop")}),f.on("dragleave",function(b){k.removeClass("zui-ready-to-drop")}),f.on("drop",function(b){k.removeClass("zui-ready-to-drop")}));e.setData("zmoduleuibuttonfileoption",b);e.setData("zmoduleuibuttonfilexhrs",[]);var n=k.find(".zui-button-label");f.on("change",function(c,h){b=e.getData("zmoduleuibuttonfileoption");var d=!1;try{d=c.original?c.original.target?c.original.target:c.original.srcElement?
c.original.srcElement:!1:!1}catch(l){}if(d&&"undefined"!=typeof d.files)for(var g=[],d=0;d<c.original.target.files.length;d++)v(c.original.target.files[d])&&g.push(w(c.original.target.files[d]));else if(h.files)for(g=[],d=0;d<h.files.length;d++)v(h.files[d])&&g.push(w(h.files[d]));else{var d="",f=0;h.value?d=h.value.replace(/.*(\/|\\)/,""):(d=null!=h.fileName?h.fileName:h.name,f=null!=h.fileSize?h.fileSize:h.size);g=[{name:d,size:f,upsize:0}]}try{e.trigger("ui.button.file.change",{files:g})}catch(l){zjs.log("your handler for event <b>ui.button.file.change</b> has error! (see console log)"),
console.log(l)}if(0<b.maxNumberOfFile&&g.length>b.maxNumberOfFile)try{e.trigger("ui.button.file.maxnumberoffile",{files:g})}catch(l){zjs.log("your handler for event <b>ui.button.file.maxnumberoffile</b> has error! (see console log)"),console.log(l)}else{f=[];if(""!=b.allowFileExt.trim())for(var x=b.allowFileExt.toLowerCase().split(/\s*,\s*/),d=0;d<g.length;d++)x.include(g[d].ext)||f.push(g[d]);if(""!=b.notallowFileExt.trim())for(x=b.notallowFileExt.toLowerCase().split(/\s*,\s*/),d=0;d<g.length;d++)x.include(g[d].ext)&&
f.push(g[d]);if(0<f.length)try{e.trigger("ui.button.file.wrongfileext",{files:f})}catch(l){zjs.log("your handler for event <b>ui.button.file.wrongfileext</b> has error! (see console log)"),console.log(l)}else{if(0<b.maxFileSize){f=[];for(d=0;d<g.length;d++)g[d].size>b.maxFileSize&&f.push(g[d]);if(0<f.length){try{e.trigger("ui.button.file.maxfilesize",{files:f})}catch(l){zjs.log("your handler for event <b>ui.button.file.maxfilesize</b> has error! (see console log)"),console.log(l)}return}}b.getFileContent&&
"FileReader"in window&&zjs.each(h.files,function(a,d){if(v(a)){var c=new FileReader;c.onload=function(d){var c={file:a,progressEvent:d,content:d.target.result};b.readEXIF?zjs.require("exif",function(){c.exif=zjs.readEXIFFromBase64(d.target.result);e.trigger("ui.button.file.getcontent",c)}):e.trigger("ui.button.file.getcontent",c)};c.readAsDataURL(a)}});if("form"==b.autoupload){try{e.trigger("ui.button.file.upload.begin",{files:g})}catch(l){zjs.log("your handler for event <b>ui.button.file.upload.begin</b> has error! (see console log)"),
console.log(l)}k.addClass("zui-loading-icon","disabled");var m=n.getInnerHTML();""!=b.uploadingText&&(k.addClass("zui-loading-icon-with-text"),n.html(b.uploadingText.format({percent:0})));try{e.trigger("ui.button.file.upload.loading",{files:g,percent:0})}catch(l){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),console.log(l)}A(h,b.autouploadUrl,b.returntype,b.data,b,function(a){for(var d=0;d<g.length;d++)g[d].upsize=g[d].size;""!=b.uploadingText&&
n.html(b.uploadingText.format({percent:100}));try{e.trigger("ui.button.file.upload.loading",{files:g,percent:100})}catch(u){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),console.log(u)}try{e.trigger("ui.button.file.upload.complete",{files:g,response:a})}catch(u){zjs.log("your handler for event <b>ui.button.file.upload.complete</b> has error! (see console log)"),console.log(u)}k.removeClass("zui-loading-icon","zui-loading-icon-with-text","disabled",
"hover");""!=b.uploadingText&&n.html(m);if(b.autouploadClear&&"-webkit-"==zjs.browser.cssprefix){try{h.files=null}catch(u){}try{h.value=null}catch(u){}try{h.fileName=null}catch(u){}}})}else if("ajax"==b.autoupload&&b.uploadMultipleFilesAtOneTime){try{e.trigger("ui.button.file.upload.begin",{files:g})}catch(l){zjs.log("your handler for event <b>ui.button.file.upload.begin</b> has error! (see console log)"),console.log(l)}k.addClass("zui-loading-icon").addClass("disabled");m=n.getInnerHTML();""!=b.uploadingText&&
k.addClass("zui-loading-icon-with-text");try{e.trigger("ui.button.file.upload.loading",{files:g,percent:0})}catch(l){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),console.log(l)}B(h,b.autouploadUrl,b.returntype,b.data,b,function(a,d){for(var c=0;c<g.length;c++)g[c].upsize=g[c].size*d/100;""!=b.uploadingText&&n.html(b.uploadingText.format({percent:d}));try{e.trigger("ui.button.file.upload.loading",{files:g,percent:d})}catch(t){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),
console.log(t)}},function(a,d){for(var c=0;c<g.length;c++)g[c].upsize=g[c].size;try{e.trigger("ui.button.file.upload.complete",{files:g,response:d})}catch(t){zjs.log("your handler for event <b>ui.button.file.upload.complete</b> has error! (see console log)"),console.log(t)}k.removeClass("zui-loading-icon","zui-loading-icon-with-text","disabled","hover");""!=b.uploadingText&&n.html(m)},function(b){})}else"ajax"!=b.autoupload||b.uploadMultipleFilesAtOneTime||C(h,b.autouploadUrl,b.returntype,b.data,
b,a,function(b,a,d){try{e.trigger("ui.button.file.upload.begin",{id:a,file:d})}catch(t){zjs.log("your handler for event <b>ui.button.file.upload.begin</b> has error! (see console log)"),console.log(t)}},function(b,a,d,c){try{e.trigger("ui.button.file.upload.loading",{id:a,file:d,percent:c})}catch(y){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),console.log(y)}},function(b,a,d,c){try{e.trigger("ui.button.file.upload.complete",{id:a,file:d,response:c})}catch(y){zjs.log("your handler for event <b>ui.button.file.upload.complete</b> has error! (see console log)"),
console.log(y)}},function(b,a,d){try{e.trigger("ui.button.file.upload.abort",{id:a,file:d})}catch(t){zjs.log("your handler for event <b>ui.button.file.upload.abort</b> has error! (see console log)"),console.log(t)}})}}});zjs.enablehook(m)}}},v=function(a){try{return"object"==typeof a&&a.constructor===File}catch(c){}return!1},w=function(a){return{name:a.name,size:a.size,upsize:0,ext:a.name.split(/\s*\.\s*/).pop().toLowerCase(),type:a.type}},A=function(){var a=0,c=!1;zjs.onready(function(){c=zjs("<div>").appendTo("body").style({position:"fixed",
top:-5E3,left:-5E3,opacity:0,display:"none"})});return function(e,b,m,p,k,f){var n=zjs(e),r=n.parent();e="zjsautouploadform"+a++;k=zjs('<iframe src="javascript:false;" name="'+e+'" />').appendTo(c);var h=zjs("<form>").setAttr({method:"post",enctype:"multipart/form-data",action:b,target:e}).appendTo(c);n.appendTo(h);zjs.foreach(p,function(b,a){zjs('<input type="hidden" name="'+a+'" value="'+b+'" />').appendTo(h)});k.on("load",function(b,a){if(a.parentNode&&(!a.contentDocument||!a.contentDocument.body||
"false"!=a.contentDocument.body.innerHTML)){var d=a.contentDocument?a.contentDocument:a.contentWindow.document,c="";try{c=d.body.innerHTML}catch(z){}try{""!=c&&(c=c.stripTags().replace(/^[^\[{]*(\[|{)/,function(b,a){return a}))}catch(z){}try{""!=c&&(c=c.decodeEntities())}catch(z){}c||(c="");"json"==m&&(c=c.jsonDecode());"function"==typeof f&&f.call(this,c);setTimeout(function(){zjs(a).remove()},1);r&&n.appendTo(r)}});h.submit();return!0}}(),B=function(a,c,e,b,m,p,k,f){if(!q)return!1;var n=new FormData;
zjs.each(b,function(b,a){n.append(a,b)});b=0;var r;for(b=0;b<a.files.length;b++)v(a.files[b])&&(r=a.files[b],n.append(m.name,r));b=new XMLHttpRequest;b.onerror=function(b){};b.onreadystatechange=function(){};b.onload=function(b){var a="";this.responseText&&(a=this.responseText.replace(/[\n\r]/g,""));"json"==e&&(a=a.jsonDecode());k(b,a)};b.upload.onprogress=function(a){p(a,Math.round(100/a.total*a.loaded))};b.onabort=function(a){f(a)};b.open("POST",c);b.send(n);if(m.autouploadClear){try{a.files=null}catch(h){}try{a.value=
null}catch(h){}try{a.fileName=null}catch(h){}}return!0},C=function(a,c,e,b,m,p,k,f,n,r){if(!q)return!1;var h=zjs(p);zjs.each(a.files,function(a,g){if(v(a)){var d=zjs.getUniqueId(),p=w(a),q=new FormData;zjs.each(b,function(a,b){q.append(b,a)});q.append(m.name,a);k(!1,d,p);var l=h.getData("zmoduleuibuttonfilexhrs",[]);zjs.isArray(l)||(l=[]);l[d]=new XMLHttpRequest;l[d].onerror=function(a){};l[d].onreadystatechange=function(){};l[d].onload=function(a){var b="";this.responseText&&(b=this.responseText.replace(/[\n\r]/g,
""));"json"==e&&(b=b.jsonDecode());n(a,d,p,b)};l[d].upload.onprogress=function(a){var b=Math.round(100/a.total*a.loaded);p.upsize=a.loaded;f(a,d,p,b)};l[d].onabort=function(a){r(a,d,p)};h.setData("zmoduleuibuttonfilexhrs",l);l[d].open("POST",c);l[d].send(q)}});if(m.autouploadClear){try{a.files=null}catch(d){}try{a.value=null}catch(d){}try{a.fileName=null}catch(d){}}return!0};q&&(zjs(window).on("dragenter",function(a){zjs(document.body).addClass("zui-body-ready-to-drop")}),zjs(window).on("dragover",
function(a){var c=zjs(a.toTarget()),e=!0;c?c.is("input[type=file]")||(e=!1):e=!1;e||(a.preventDefault(),a.stop());(a.original.clientX>window.innerWidth||a.original.clientY>window.innerHeight||0>=a.original.clientX||0>=a.original.clientY)&&zjs(document.body).removeClass("zui-body-ready-to-drop")}),zjs(window).on("dragleave",function(a){(a.original.clientX>window.innerWidth||a.original.clientY>window.innerHeight||0>=a.original.clientX||0>=a.original.clientY)&&zjs(document.body).removeClass("zui-body-ready-to-drop")}),
zjs(window).on("drop",function(a){var c=zjs(a.toTarget()),e=!0;c?c.is("input[type=file]")||(e=!1):e=!1;e||(a.preventDefault(),a.stop());zjs(document.body).removeClass("zui-body-ready-to-drop")}));zjs.extendCore({uploadFile:function(a){a=zjs.extend({inputName:"uploadfile",fileLocation:"",uploadUrl:"",returnType:"json",data:{},callback:function(){}},a);var c=zjs('<input type="file" name="'+a.inputName+'" value="'+a.fileLocation+'" />');return 0>=c.count()?!1:A(c,a.uploadUrl,a.returnType,a.data,a.callback)}});
zjs.extendMethod({makeButtonFile:function(a){return this.each(function(c){D(c,a)})},buttonFileSetData:function(a,c){return this.each(function(e){e=zjs(e);var b=e.getData("zmoduleuibuttonfileoption");b&&(b.data[a]=c,e.setData("zmoduleuibuttonfileoption",b))})},buttonFileAbortUpload:function(a){return this.each(function(c){q&&(c=zjs(c),c.getData("zmoduleuibuttonfileoption")&&(c=c.getData("zmoduleuibuttonfilexhrs",[]),c[a]&&c[a].abort()))})}});zjs.hook({after_setInnerHTML:function(a){zjs(a).find(".zbuttonfile").makeButtonFile()},
after_insertDOM:function(a){zjs(a).hasClass("zbuttonfile")&&zjs(a).makeButtonFile();zjs(a).find(".zbuttonfile").makeButtonFile()}});zjs.onready(function(){zjs(".zbuttonfile").makeButtonFile()});"required"in zjs&&zjs.required("ui.button.file")});