zjs.require("ui.button",function(){var e="zmoduleuibuttonfileoption",t="zmoduleuibuttonfilexhrs",o="zmoduleuibuttonfilebtnel",n="zmoduleuibuttonfileinputel";zjs.extendCore({moduleUiButtonFileOption:{name:"",text:"Choose File",data:{},multiple:!0,autoupload:"ajax",autouploadUrl:"",autouploadClear:!0,uploadMultipleFilesAtOneTime:!0,maxFileSize:10485760,maxNumberOfFile:10,allowFileExt:"",notallowFileExt:"php,exe,asp",returntype:"json",uploadingText:"",dropText:"",getFileContent:!1,readEXIF:!1}});var l,i,a="zui-button-file",r="zui-support-drag-drop",u="disabled",s="hover",d="active",f="zui-loading-icon",c="zui-button-drop-text",p="zui-button-label",g="zui-loading-icon-with-text",m="zui-body-ready-to-drop",h="zui-ready-to-drop",b="uploadfile",z=function(){var e=!1;window.XMLHttpRequest&&(e=new window.XMLHttpRequest);var t=document.createElement("INPUT");t.type="file";var o=!!window.FormData;return"files"in t&&e&&e.upload&&"onprogress"in e.upload&&o}(),v=function(l,i){var m=zjs(l),v=m.getData(e);if(v)m.setData(e,zjs.extend(v,i));else{v=zjs.clone(zjs.moduleUiButtonFileOption);var x=m.getAttr("data-option","");zjs.isString(x)&&""!=x.trim()&&(v=zjs.extend(v,x.jsonDecode())),m.removeAttr("data-option"),void 0!==i&&(v=zjs.extend(v,i));var C=zjs.enablehook();zjs.enablehook(!1),""==v.autouploadUrl&&(v.autoupload=""),"ajax"!=v.autoupload||z||(v.autoupload="form"),v.uploadMultipleFilesAtOneTime=!!v.uploadMultipleFilesAtOneTime;var D=m.is("input")?"input":"a";if("input"!=D||m.is("[type=file]")){if("a"==D)var M=zjs(l),A=zjs('<input type="file">');if("input"==D)A=zjs(l),M=zjs("<a>").html(v.text).insertBefore(A);if(m.setData(o,M),m.setData(n,A),window.attachEvent&&A.attr("tabIndex",-1),v.multiple)try{A.item(0,!0).multiple=!0}catch(e){}"multiple"in A.item(0,!0)&&A.item(0,!0).multiple?v.multiple=!0:(v.multiple=!1,A.item(0,!0).multiple=!1),""==v.name&&""==A.getAttr("name","")&&A.attr("name",b),""!=v.name&&""==A.getAttr("name","")&&A.attr("name",v.name),("form"==v.autoupload||v.uploadMultipleFilesAtOneTime)&&v.multiple&&A.attr("name")&&!A.attr("name").test(/\[\]$/)&&A.attr("name",A.attr("name")+"[]"),v.name=A.attr("name"),"ajax"==v.autoupload&&"a"==D&&A.removeAttr("name"),""==v.dropText&&(v.dropText="Drop here to upload"),M.makeButton().addClass(a).style({position:"relative",overflow:"hidden",direction:"ltr"}),A.appendTo(M).style({position:"absolute",right:"0px",top:"0px","font-family":"Arial","font-size":"118px",margin:"0px",padding:"0px","min-height":"100%","min-width":"100%",cursor:"pointer",opacity:0}).hover(function(){A.style("cursor",M.hasClass(u)?"default":"pointer"),M.addClass(s)},function(){M.removeClass(s+" "+d)}).on("mousedown",function(){M.addClass(d)}).on("mouseup",function(){M.removeClass(d)}),"ajax"==v.autoupload&&z&&(M.addClass(r).prepend('<span class="'+c+'">'+v.dropText+"</span>"),A.on("dragenter",function(e){M.hasClass(u)||M.addClass(h)}),A.on("dragleave",function(e){M.removeClass(h)}),A.on("drop",function(e){M.removeClass(h)})),m.setData(e,v),m.setData(t,[]);var E=M.find("."+p);A.on("change",function(t,o){v=m.getData(e);var n=!1;try{n=!!t.original&&(t.original.target?t.original.target:!!t.original.srcElement&&t.original.srcElement)}catch(e){}if(n&&void 0!==n.files)for(var i=[],a=0;a<t.original.target.files.length;a++)j(t.original.target.files[a])&&i.push(y(t.original.target.files[a]));else if(o.files)for(i=[],a=0;a<o.files.length;a++)j(o.files[a])&&i.push(y(o.files[a]));else{var r="",d=0;if(o.value){var c=o.value;r=c.replace(/.*(\/|\\)/,"")}else r=null!=o.fileName?o.fileName:o.name,d=null!=o.fileSize?o.fileSize:o.size;i=[{name:r,size:d,upsize:0}]}try{m.trigger("ui:button:file:change",{files:i})}catch(e){zjs.log("your handler for event <b>ui:button:file:change</b> has error! (see console log)"),console.log(e)}if(v.maxNumberOfFile>0&&i.length>v.maxNumberOfFile)try{m.trigger("ui:button:file:maxnumberoffile",{files:i})}catch(e){zjs.log("your handler for event <b>ui:button:file:maxnumberoffile</b> has error! (see console log)"),console.log(e)}else{var p=Array();if(""!=v.allowFileExt.trim()){var h=v.allowFileExt.toLowerCase().split(/\s*,\s*/);for(a=0;a<i.length;a++)h.include(i[a].ext)||p.push(i[a])}if(""!=v.notallowFileExt.trim()){var b=v.notallowFileExt.toLowerCase().split(/\s*,\s*/);for(a=0;a<i.length;a++)b.include(i[a].ext)&&p.push(i[a])}if(p.length>0)try{m.trigger("ui:button:file:wrongfileext",{files:p})}catch(e){zjs.log("your handler for event <b>ui:button:file:wrongfileext</b> has error! (see console log)"),console.log(e)}else{if(v.maxFileSize>0){var z=Array();for(a=0;a<i.length;a++)i[a].size>v.maxFileSize&&z.push(i[a]);if(z.length>0){try{m.trigger("ui:button:file:maxfilesize",{files:z})}catch(e){zjs.log("your handler for event <b>ui:button:file:maxfilesize</b> has error! (see console log)"),console.log(e)}return}}if(v.getFileContent&&"FileReader"in window&&zjs.each(o.files,function(e,t){if(j(e)){var o=new FileReader;o.onload=function(t){var o={file:e,progressEvent:t,content:t.target.result};v.readEXIF?zjs.require("exif",function(){o.exif=zjs.readEXIFFromBase64(t.target.result),m.trigger("ui:button:file:getcontent",o)}):m.trigger("ui:button:file:getcontent",o)},o.readAsDataURL(e)}}),"form"==v.autoupload){try{m.trigger("ui:button:file:upload:begin",{files:i})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:begin</b> has error! (see console log)"),console.log(e)}M.addClass(f,u);var x=E.getInnerHTML();""!=v.uploadingText&&(M.addClass(g),E.html(v.uploadingText.format({percent:0})));try{m.trigger("ui:button:file:upload:loading",{files:i,percent:0})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:loading</b> has error! (see console log)"),console.log(e)}w(o,v.autouploadUrl,v.returntype,v.data,v,function(e){for(var t=0;t<i.length;t++)i[t].upsize=i[t].size;""!=v.uploadingText&&E.html(v.uploadingText.format({percent:100}));try{m.trigger("ui:button:file:upload:loading",{files:i,percent:100})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:loading</b> has error! (see console log)"),console.log(e)}try{m.trigger("ui:button:file:upload:complete",{files:i,response:e})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:complete</b> has error! (see console log)"),console.log(e)}if(M.removeClass(f,g,u,s),""!=v.uploadingText&&E.html(x),v.autouploadClear&&"-webkit-"==zjs.browser.cssprefix){try{o.files=null}catch(e){}try{o.value=null}catch(e){}try{o.fileName=null}catch(e){}}})}else if("ajax"==v.autoupload&&v.uploadMultipleFilesAtOneTime){try{m.trigger("ui:button:file:upload:begin",{files:i})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:begin</b> has error! (see console log)"),console.log(e)}M.addClass(f).addClass(u);x=E.getInnerHTML();""!=v.uploadingText&&M.addClass(g);try{m.trigger("ui:button:file:upload:loading",{files:i,percent:0})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:loading</b> has error! (see console log)"),console.log(e)}T(o,v.autouploadUrl,v.returntype,v.data,v,function(e,t){for(var o=0;o<i.length;o++)i[o].upsize=i[o].size*t/100;""!=v.uploadingText&&E.html(v.uploadingText.format({percent:t}));try{m.trigger("ui:button:file:upload:loading",{files:i,percent:t})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:loading</b> has error! (see console log)"),console.log(e)}},function(e,t){for(var o=0;o<i.length;o++)i[o].upsize=i[o].size;try{m.trigger("ui:button:file:upload:complete",{files:i,response:t})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:complete</b> has error! (see console log)"),console.log(e)}M.removeClass(f,g,u,s),""!=v.uploadingText&&E.html(x)},function(e){})}else"ajax"!=v.autoupload||v.uploadMultipleFilesAtOneTime||F(o,v.autouploadUrl,v.returntype,v.data,v,l,function(e,t,o){try{m.trigger("ui:button:file:upload:begin",{id:t,file:o})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:begin</b> has error! (see console log)"),console.log(e)}},function(e,t,o,n){try{m.trigger("ui:button:file:upload:loading",{id:t,file:o,percent:n})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:loading</b> has error! (see console log)"),console.log(e)}},function(e,t,o,n){try{m.trigger("ui:button:file:upload:complete",{id:t,file:o,response:n})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:complete</b> has error! (see console log)"),console.log(e)}},function(e,t,o){try{m.trigger("ui:button:file:upload:abort",{id:t,file:o})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:abort</b> has error! (see console log)"),console.log(e)}},function(e,t,o){try{m.trigger("ui:button:file:upload:error",{e:e,id:t,file:o})}catch(e){zjs.log("your handler for event <b>ui:button:file:upload:error</b> has error! (see console log)"),console.log(e)}})}}}),zjs.enablehook(C)}}},j=function(e){try{return"object"==typeof e&&e.constructor===File}catch(e){}return!1},y=function(e){return{name:e.name,size:e.size,upsize:0,ext:e.name.split(/\s*\.\s*/).pop().toLowerCase(),type:e.type}},x=function(t,o,n){var l=zjs(t),i=l.getData(e);i&&(i.data[o]=n,l.setData(e,i))},w=(l=0,i=!1,zjs.onready(function(){i=zjs("<div>").appendTo("body").style({position:"fixed",top:-5e3,left:-5e3,opacity:0,display:"none"})}),function(e,t,o,n,a,r){var u=zjs(e),s=u.parent(),d="zjsautouploadform"+l++,f=zjs('<iframe src="javascript:false;" name="'+d+'" />').appendTo(i),c=zjs("<form>").setAttr({method:"post",enctype:"multipart/form-data",action:t,target:d}).appendTo(i);return u.appendTo(c),zjs.foreach(n,function(e,t){zjs('<input type="hidden" name="'+t+'" value="'+e+'" />').appendTo(c)}),f.on("load",function(e,t){if(t.parentNode&&(!t.contentDocument||!t.contentDocument.body||"false"!=t.contentDocument.body.innerHTML)){var n=t.contentDocument?t.contentDocument:t.contentWindow.document,l="";try{l=n.body.innerHTML}catch(e){}try{""!=l&&(l=l.stripTags().replace(/^[^\[{]*(\[|{)/,function(e,t){return t}))}catch(e){}try{""!=l&&(l=l.decodeEntities())}catch(e){}l||(l=""),"json"==o&&(l=l.jsonDecode()),"function"==typeof r&&r.call(this,l),setTimeout(function(){zjs(t).remove()},1),s&&u.appendTo(s)}}),c.submit(),!0}),T=function(e,t,o,n,l,i,a,r){if(!z)return!1;var u=new FormData;if(u){zjs.each(n,function(e,t){u.append(t,e)});var s,d=0;for(d=0;d<e.files.length;d++)j(e.files[d])&&(s=e.files[d],u.append(l.name,s));var f=new XMLHttpRequest;if(f.onerror=function(e){},f.onreadystatechange=function(){},f.onload=function(e){var t="";this.responseText&&(t=this.responseText.replace(/[\n\r]/g,"")),"json"==o&&(t=t.jsonDecode()),a(e,t)},f.upload.onprogress=function(e){var t=Math.round(100/e.total*e.loaded);i(e,t)},f.onabort=function(e){r(e)},f.open("POST",t),f.send(u),l.autouploadClear){try{e.files=null}catch(e){}try{e.value=null}catch(e){}try{e.fileName=null}catch(e){}}return!0}},F=function(e,o,n,l,i,a,r,u,s,d,f){if(!z)return!1;var c=zjs(a);if(zjs.each(e.files,function(e,a){if(j(e)){var p=zjs.getUniqueId(),g=y(e),m=new FormData;if(m){zjs.each(l,function(e,t){m.append(t,e)}),m.append(i.name,e),r(!1,p,g);var h=c.getData(t,[]);zjs.isArray(h)||(h=[]),h[p]=new XMLHttpRequest,h[p].onerror=function(e){f(e,p,g)},h[p].onreadystatechange=function(){},h[p].onload=function(e){var t="";this.responseText&&(t=this.responseText.replace(/[\n\r]/g,"")),"json"==n&&(t=t.jsonDecode()),s(e,p,g,t)},h[p].upload.onprogress=function(e){var t=Math.round(100/e.total*e.loaded);g.upsize=e.loaded,u(e,p,g,t)},h[p].onabort=function(e){d(e,p,g)},c.setData(t,h),h[p].open("POST",o),h[p].send(m)}}}),i.autouploadClear){try{e.files=null}catch(e){}try{e.value=null}catch(e){}try{e.fileName=null}catch(e){}}return!0},C=function(o,n){if(z){var l=zjs(o),i=l.getData(e);if(i){var a=l.getData(t,[]);a[n]&&a[n].abort()}}};z&&(zjs(window).on("dragenter",function(e){zjs(document.body).addClass(m)}),zjs(window).on("dragover",function(e){var t=zjs(e.toTarget()),o=!0;t&&t.is("input[type=file]")||(o=!1),o||(e.preventDefault(),e.stop()),(e.original.clientX>window.innerWidth||e.original.clientY>window.innerHeight||e.original.clientX<=0||e.original.clientY<=0)&&zjs(document.body).removeClass(m)}),zjs(window).on("dragleave",function(e){(e.original.clientX>window.innerWidth||e.original.clientY>window.innerHeight||e.original.clientX<=0||e.original.clientY<=0)&&zjs(document.body).removeClass(m)}),zjs(window).on("drop",function(e){var t=zjs(e.toTarget()),o=!0;t&&t.is("input[type=file]")||(o=!1),o||(e.preventDefault(),e.stop()),zjs(document.body).removeClass(m)})),zjs.extendCore({uploadFile:function(e){e=zjs.extend({inputName:"uploadfile",fileLocation:"",uploadUrl:"",returnType:"json",data:{},callback:function(){}},e);var t=zjs('<input type="file" name="'+e.inputName+'" value="'+e.fileLocation+'" />');return!(t.count()<=0)&&w(t,e.uploadUrl,e.returnType,e.data,e.callback)}}),zjs.extendMethod({makeButtonFile:function(e){return this.each(function(t){v(t,e)})},buttonFileSetData:function(e,t){return this.each(function(o){x(o,e,t)})},buttonFileAbortUpload:function(e){return this.each(function(t){C(t,e)})}}),zjs.hook({after_setInnerHTML:function(e){zjs(e).find(".zbuttonfile").makeButtonFile()},after_insertDOM:function(e){zjs(e).hasClass("zbuttonfile")&&zjs(e).makeButtonFile(),zjs(e).find(".zbuttonfile").makeButtonFile()}}),zjs.onready(function(){zjs(".zbuttonfile").makeButtonFile()}),"required"in zjs&&zjs.required("ui.button.file")});